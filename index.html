<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>ChronoVerse</title>

  <!-- PWA meta -->
  <meta name="theme-color" content="#2a7aee">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon.png"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --panelW: 20vw;
      --panelMin: 220px;
      --panelMax: 360px;
      --panelBg: rgba(255,255,255,.80);
      --panelBgHover: rgba(255,255,255,.95);
      --panelBlur: 8px;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family: Inter, Arial, sans-serif; background:#fff; }
    .app { display:flex; height:100vh; width:100vw; }

    .sidebar, .right {
      width: var(--panelW); min-width: var(--panelMin); max-width: var(--panelMax);
      background: var(--panelBg); backdrop-filter: blur(var(--panelBlur));
      border-right:1px solid #e5e5e5; padding:14px; overflow:auto;
      transition: background .2s ease;
    }
    .sidebar:hover, .right:hover { background: var(--panelBgHover); }
    .right { border-right:none; border-left:1px solid #e5e5e5; }
    .mapwrap { flex:1; position:relative; display:flex; flex-direction:column; }
    #map { flex:1; }

    .row { display:flex; align-items:center; gap:8px; }
    .btn { padding:8px 10px; border:1px solid #d8dbe2; border-radius:10px; cursor:pointer; background:#f7f8fc; }
    .btn.primary { background:#2a7aee; border-color:#2a7aee; color:#fff; }
    .btn.ghost { background:#fff; }
    .error { color:#d33; font-size:13px; margin-top:6px; }
    .title { margin:0 0 10px 0; }
    ul { list-style:none; margin:0; padding:0; }
    .user-item { padding:8px; border-radius:10px; cursor:pointer; }
    .user-item:hover { background:#f4f6fb; }
    .submenu { display:none; padding:8px; background:#fafafa; border:1px solid #eee; border-radius:10px; margin-top:6px; }
    .submenu.active { display:block; }
    .muted { color:#666; font-size:13px; }
    .kpi { margin:4px 0; }
    .badge { display:inline-flex; align-items:center; justify-content:center; min-width:20px; height:20px; border-radius:999px; background:#e11d48; color:#fff; font-size:12px; padding:0 6px; }

    /* Popups & thumbnails */
    .popup { width:280px; }
    .popup img { width:100%; border-radius:12px; margin-bottom:6px; }
    .popup .like { cursor:pointer; font-size:18px; user-select:none; }
    .popup .comments { max-height:160px; overflow:auto; border-top:1px solid #eee; margin-top:6px; padding-top:6px; font-size:13px; }
    .popup .menu-trigger { margin-left:auto; cursor:pointer; font-size:18px; }

    .thumb-marker { width:42px; height:42px; border-radius:10px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.22); border:2px solid #fff; }
    .thumb-marker img { width:100%; height:100%; object-fit:cover; display:block; }

    /* Map hint + overlay + modals */
    .hint { position:absolute; top:10px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:6px 10px; border-radius:999px; font-size:12px; display:none; z-index:500; }
    .hint.active { display:inline-block; }

    .overlay { position:absolute; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,.32); z-index:1000; display:none; }
    .overlay.active { display:block; }

    .photo-form {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:#fff; border-radius:14px; box-shadow:0 14px 36px rgba(0,0,0,.18);
      padding:16px; width:360px; z-index:1001; display:none;
    }
    .photo-form.active { display:block; }

    /* Dropdown */
    .dropdown { position:relative; }
    .dropdown-menu { position:absolute; right:0; top:28px; background:#fff; border:1px solid #eaeaea; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.14); display:none; min-width:200px; z-index:1200; }
    .dropdown-menu.active { display:block; }
    .dropdown-menu button { width:100%; text-align:left; padding:10px 12px; border:0; background:#fff; cursor:pointer; border-radius:10px; }
    .dropdown-menu button:hover { background:#f7f8fc; }

    /* Notifications dropdown */
    .notifWrap { position:relative; }
    .notifDropdown { position:absolute; right:0; top:40px; width:320px; max-height:60vh; overflow:auto; background:#fff; border:1px solid #eaeaea; border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,.14); display:none; }
    .notifDropdown.active { display:block; }
    .notifItem { padding:10px 12px; border-bottom:1px solid #f1f1f1; }
    .notifItem:last-child { border-bottom:0; }

    /* Saƒü panel i√ßi b√∂l√ºmler */
    .section { border:1px dashed #e0e0e0; border-radius:12px; padding:12px; margin:10px 0; }
    .section.hidden { display:none; }

    /* Feature grid */
    .featureBtns { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px; }

    /* Map search box (top-right) */
    .map-search {
      position:absolute; right:10px; top:10px; z-index:700;
      background:rgba(255,255,255,.92); backdrop-filter: blur(8px);
      border:1px solid #e5e5e5; border-radius:12px; padding:8px; display:flex; gap:6px; align-items:center;
      width:min(320px, 60vw);
    }
    .map-search input { flex:1; padding:8px; border:1px solid #d8dbe2; border-radius:8px; }
    .map-search .results { position:absolute; right:0; top:46px; background:#fff; border:1px solid #e5e5e5; border-radius:10px; width:100%; max-height:50vh; overflow:auto; display:none; }
    .map-search .results.active { display:block; }
    .map-search .results div { padding:8px 10px; cursor:pointer; }
    .map-search .results div:hover { background:#f7f8fc; }

    /* Avatarlƒ± kullanƒ±cƒ± listesi */
    .user-line { display:flex; gap:8px; align-items:center; }
    .avatar-sm { width:22px; height:22px; border-radius:50%; object-fit:cover; background:#eee; border:1px solid #fff; }

    /* Mobile */
    #menuToggle {
      display:none; position:absolute; top:10px; left:10px; z-index:3000; background:#fff; padding:8px 10px;
      border-radius:12px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.2);
    }
    @media (max-width:1024px){ :root{ --panelW: 26vw; } }
    @media (max-width:900px){ :root{ --panelW: 30vw; --panelMax: 330px; } }
    @media (max-width:768px) {
  #menuToggle { display:block; }
  .sidebar, .right {
    position:absolute; top:0; bottom:0; width:88%; z-index:2000;
    transform:translateX(-100%);
    transition:transform .28s ease-in-out;
    background:#fff;
  }
  .sidebar.active { transform:translateX(0); }
  .right.active { transform:translateX(0); right:0; left:auto; }
  .right { z-index: 2500; }
}

  </style>
</head>
<body>
  <div class="app">
    <div id="menuToggle">‚ò∞</div>

    <!-- SOL PANEL -->
    <aside class="sidebar">
      <div class="row" style="justify-content:space-between;">
        <h3 class="title">Top 10 Users</h3>
        <div class="row">
          <button id="homeBtn" class="btn ghost" title="T√ºm fotoƒüraflar">üè†</button>
          <button id="refreshBtn" class="btn ghost" title="Yenile">‚ü≥</button>
        </div>
      </div>
      <input id="searchUser" type="text" placeholder="Kullanƒ±cƒ± ara..." style="width:100%; margin-bottom:10px;"/>
      <ul id="searchResults"></ul>
      <ul id="topList"></ul>
      <p class="muted" style="margin-top:10px;">Bir kullanƒ±cƒ±ya tƒ±klayƒ±n ‚Üí sadece onun fotoƒüraflarƒ± haritada g√∂r√ºns√ºn. Alt men√ºden Follow/Unfollow.</p>
    </aside>

    <!-- HARƒ∞TA -->
    <main class="mapwrap">
      <!-- Search box -->
      <div class="map-search">
        <input id="mapSearchInput" type="text" placeholder="Adres / yer ara‚Ä¶" />
        <button id="mapSearchBtn" class="btn">Ara</button>
        <div id="mapSearchResults" class="results"></div>
      </div>

      <div id="map"></div>
      <div id="hint" class="hint">Haritadan konum se√ßin‚Ä¶</div>

      <div id="overlay" class="overlay"></div>

      <!-- Fotoƒüraf Y√ºkleme Modalƒ± -->
      <div id="photoForm" class="photo-form">
        <h3>Fotoƒüraf Ekle</h3>
        <div id="chosenLoc" class="muted">Konum: ‚Äì</div>
        <div class="row" style="justify-content:space-between; margin-bottom:6px;">
          <button id="pickOnMap" class="btn ghost">Haritadan se√ß</button>
          <small class="muted">Se√ßmezsen harita merkezi kullanƒ±lƒ±r</small>
        </div>
        <input type="file" id="fileInput" accept="image/*" />
        <div id="previewWrap" style="display:none; margin-top:6px;"></div>
        <div class="row" style="justify-content:flex-end; gap:8px; margin-top:8px;">
          <button id="cancelUpload" class="btn">ƒ∞ptal</button>
          <button id="confirmUpload" class="btn primary">Y√ºkle</button>
        </div>
        <div id="uploadErr" class="error"></div>
      </div>
      <!-- SAƒû PANEL -->
    </main>
    <aside class="right">
      <button id="addPhoto" class="btn primary" style="width:100%; margin-bottom:10px;">+ Fotoƒüraf</button>

      <!-- Bildirimler -->
      <div class="notifWrap">
        <div class="row" style="gap:8px; align-items:center;">
          <button id="btnNotif" class="btn ghost">üîî Bildirimler</button>
          <span id="notifBadge" class="badge" style="display:none;">0</span>
          <button id="btnReadAll" class="btn" title="T√ºm√ºn√º okundu yap">Okundu ‚úì</button>
        </div>
        <div id="notifDropdown" class="notifDropdown">
          <div class="row" style="justify-content:space-between; align-items:center; padding:8px 12px; border-bottom:1px solid #eee; background:#fafbff;">
            <b>Bildirimler</b>
            <button id="closeNotif" class="btn">Kapat</button>
          </div>
          <div id="notifList"></div>
        </div>
      </div>

      <!-- Gƒ∞Rƒ∞≈û -->
      <div id="loginBox">
        <h3 class="title">Giri≈ü Yap</h3>
        <input id="loginEmail" type="email" placeholder="Email"/>
        <input id="loginPass" type="password" placeholder="≈ûifre"/>
        <div class="row" style="gap:8px;">
          <button id="btnLogin" class="btn primary" style="flex:1;">Giri≈ü</button>
        </div>
        <div class="row" style="gap:8px; margin-top:6px;">
          <button id="showRegister" class="btn" style="flex:1;">Yeni Kullanƒ±cƒ±</button>
        </div>
        <div id="loginErr" class="error"></div>
      </div>

      <!-- KAYIT -->
      <div id="regBox" style="display:none;">
        <h3 class="title">Kayƒ±t Ol</h3>
        <input id="regEmail" type="email" placeholder="Email"/>
        <input id="regPass" type="password" placeholder="≈ûifre"/>
        <div class="row" style="gap:8px;">
          <button id="btnRegister" class="btn primary" style="flex:1;">Kaydol</button>
          <button id="showLogin" class="btn" style="flex:1;">Giri≈üe D√∂n</button>
        </div>
        <div id="regErr" class="error"></div>
      </div>

      <!-- KULLANICI -->
      <div id="userBox" style="display:none;">
        <h3 class="title" id="hello">Ho≈ü geldin!</h3>
        <div class="kpi">Email: <b id="meEmail">‚Äì</b></div>
        <div class="kpi">Coin: <b id="meCoin">0</b></div>
        <div class="kpi">Posts: <b id="mePosts">0</b></div>
        <div class="kpi">Followers: <b id="meFollowers" style="cursor:pointer; color:#2a7aee;">0</b></div>
        <div class="kpi">Following: <b id="meFollowing" style="cursor:pointer; color:#2a7aee;">0</b></div>

        <!-- Profile Settings (butonla a√ß/kapa) -->
        <div class="row" style="gap:8px; margin-top:8px;">
          <button id="toggleProfileSettings" class="btn">Profile Settings</button>
          <button id="togglePhotoSettings" class="btn">Photo Settings</button>
        </div>

        <div id="profileSettingsSection" class="section hidden">
          <div class="row" style="align-items:center; gap:12px; margin-bottom:10px;">
            <img id="avatarPreview" src="" alt="avatar" style="width:56px; height:56px; border-radius:50%; object-fit:cover; background:#eee;"/>
            <input id="editAvatar" type="file" accept="image/*"/>
          </div>
          <input id="editUsername" type="text" placeholder="Kullanƒ±cƒ± adƒ±"/>

          <div style="margin-top:8px;">
            <button id="btnTogglePass" class="btn">Change Password</button>
            <div id="passWrap" class="row" style="gap:8px; margin-top:6px;">
              <input id="newPass" type="password" placeholder="Yeni ≈üifre" disabled/>
              <input id="newPass2" type="password" placeholder="Yeni ≈üifre tekrar" disabled/>
            </div>
          </div>
          <div class="row" style="justify-content:flex-end; gap:8px; margin-top:10px;">
            <button id="saveEdit" class="btn primary">Kaydet</button>
          </div>
          <div id="editErr" class="error"></div>
        </div>

        <!-- Photo Settings: saƒü panel i√ßinde -->
        <div id="photoSettingsSection" class="section hidden">
          <h4 style="margin:0 0 8px 0;">Fotoƒüraflarƒ±m</h4>
          <div id="psList"></div>
        </div>

        <div class="featureBtns">
          <button class="btn ghost feat" data-key="vrtour">VR Tour</button>
          <button class="btn ghost feat" data-key="challenges">Challenges</button>
          <button class="btn ghost feat" data-key="nft">NFT Collection</button>
          <button class="btn ghost feat" data-key="guide">ChronoGuide</button>
          <button class="btn ghost feat" data-key="nav">Navigation</button>
          <button class="btn ghost feat" data-key="timeline">TimeLine</button>
        </div>

        <div class="row" style="justify-content:flex-end; margin-top:10px;">
          <button id="btnLogout" class="btn">√áƒ±kƒ±≈ü</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Supabase Client -->
  <script>
    // Supabase ayarlarƒ±n
    const supabaseUrl = "https://bzewcgcwtdqnorlclcyd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6ZXdjZ2N3dGRxbm9ybGNsY3lkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTE2ODgsImV4cCI6MjA3MjM4NzY4OH0.s8GnQGeyhoXL-R2acBtdPmI3RAYLxk-CwvyW001hY6w";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });
  </script>

  <!-- App JS -->
  <script>
    // Manifest linkini sadece http/https altƒ±nda ekle (file:// CORS uyarƒ±sƒ±nƒ± engeller)
    (function(){
      var proto = window.location.protocol;
      if (proto === "http:" || proto === "https:") {
        var l = document.createElement('link');
        l.rel = 'manifest';
        l.href = 'manifest.json';
        document.head.appendChild(l);
      }
    })();

    // Helpers
    function qs(sel){ return document.querySelector(sel); }
    function escapeHtml(str){
      str = str || "";
      return str.replace(/[&<>"']/g, function(m){ return ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" })[m]; });
    }
    async function compressImageIfNeeded(file, maxDim, maxMB){
      try{
        if (!file || !/^image\//.test(file.type)) return file;
        var url = URL.createObjectURL(file);
        var img = await new Promise(function(res, rej){ var im = new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=url; });
        var w = img.width, h = img.height, scale = Math.min(1, maxDim/Math.max(w,h));
        var c = document.createElement('canvas'); c.width = Math.round(w*scale); c.height = Math.round(h*scale);
        var ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
        var q=0.9, blob = await new Promise(r=>c.toBlob(r,'image/jpeg',q));
        while(blob && blob.size>maxMB*1024*1024 && q>0.5){ q-=0.1; blob=await new Promise(r=>c.toBlob(r,'image/jpeg',q)); }
        URL.revokeObjectURL(url);
        if (!blob) return file;
        if (blob.size < file.size) return new File([blob], (file.name.split('.').slice(0,-1).join('.')||'image')+'.jpg', {type:'image/jpeg'});
        return file;
      }catch(e){ return file; }
    }

    // Leaflet Map
    var map = L.map("map", { tapTolerance: 15 }).setView([39, 35], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap" }).addTo(map);

    function thumbIcon(url){
      return L.divIcon({
        className: '',
        html: '<div class="thumb-marker"><img src="'+url+'" alt="" loading="lazy" decoding="async"/></div>',
        iconSize: [42,42], iconAnchor:[21,21], popupAnchor:[0,-18]
      });
    }

    var markers = [];
    function clearMarkers(){ while(markers.length){ try{ map.removeLayer(markers.pop()); }catch(e){} } }
    // Refs
    var $ = {
      // left
      topList: qs("#topList"), homeBtn: qs("#homeBtn"), refreshBtn: qs("#refreshBtn"),
      searchUser: qs("#searchUser"), searchResults: qs("#searchResults"),
      // map
      mapSearchInput: qs("#mapSearchInput"), mapSearchBtn: qs("#mapSearchBtn"), mapSearchResults: qs("#mapSearchResults"),
      hint: qs("#hint"), overlay: qs("#overlay"), photoForm: qs("#photoForm"),
      chosenLoc: qs("#chosenLoc"), fileInput: qs("#fileInput"), uploadErr: qs("#uploadErr"),
      cancelUpload: qs("#cancelUpload"), confirmUpload: qs("#confirmUpload"),
      pickOnMap: qs("#pickOnMap"), previewWrap: qs("#previewWrap"),
      // right
      addPhoto: qs("#addPhoto"),
      loginBox: qs("#loginBox"), regBox: qs("#regBox"), userBox: qs("#userBox"),
      loginEmail: qs("#loginEmail"), loginPass: qs("#loginPass"),
      btnLogin: qs("#btnLogin"), showRegister: qs("#showRegister"),
      regEmail: qs("#regEmail"), regPass: qs("#regPass"),
      btnRegister: qs("#btnRegister"), showLogin: qs("#showLogin"),
      loginErr: qs("#loginErr"), regErr: qs("#regErr"),
      meEmail: qs("#meEmail"), meCoin: qs("#meCoin"), mePosts: qs("#mePosts"),
      meFollowers: qs("#meFollowers"), meFollowing: qs("#meFollowing"),
      btnLogout: qs("#btnLogout"),
      // profile settings in-panel
      toggleProfileSettings: qs("#toggleProfileSettings"),
      togglePhotoSettings: qs("#togglePhotoSettings"),
      profileSettingsSection: qs("#profileSettingsSection"),
      photoSettingsSection: qs("#photoSettingsSection"),
      editUsername: qs("#editUsername"), editAvatar: qs("#editAvatar"),
      avatarPreview: qs("#avatarPreview"),
      btnTogglePass: qs("#btnTogglePass"), newPass: qs("#newPass"), newPass2: qs("#newPass2"),
      saveEdit: qs("#saveEdit"), editErr: qs("#editErr"),
      psList: qs("#psList"),
      // notifications
      notifDropdown: qs("#notifDropdown"), notifList: qs("#notifList"),
      notifBadge: qs("#notifBadge"), btnNotif: qs("#btnNotif"), btnReadAll: qs("#btnReadAll"), closeNotif: qs("#closeNotif")
    };

    function setModal(open){ $.overlay.classList.toggle("active", open); $.photoForm.classList.toggle("active", open); }

    // Auth / session
    var notifChannel = null;
    async function getSessionUser(){
      var s = await supabase.auth.getSession();
      return s && s.data && s.data.session ? s.data.session.user : null;
    }

    async function getAvatarUrl(userId){
      // 1) profile.avatar_url ‚Üí 2) first photo ‚Üí 3) placeholder
      var pr = await supabase.from("user_profiles").select("avatar_url").eq("id", userId).single();
      if (pr && pr.data && pr.data.avatar_url) return pr.data.avatar_url;
      var fp = await supabase.from("photos").select("image_url").eq("user_id", userId).order("id", {ascending:true}).limit(1);
      if (fp && fp.data && fp.data.length) return fp.data[0].image_url;
      // tiny svg placeholder
      return "data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#e5e7eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="14">?</text></svg>');
    }

    async function refreshAvatarPreview(userId){
      var url = await getAvatarUrl(userId);
      $.avatarPreview.src = url || "";
    }

    async function updateUserPanel(userId){
      var profileRes = await supabase.from("user_profiles").select("*").eq("id", userId).single();
      var profile = profileRes ? profileRes.data : null;
      if (profile){
        $.meCoin.textContent = (profile.coin || 0);
        $.mePosts.textContent = (profile.posts || 0);
      }
      var f1 = await supabase.from("follows").select("*",{count:"exact",head:true}).eq("following", userId);
      $.meFollowers.textContent = f1 && typeof f1.count === 'number' ? f1.count : 0;
      var f2 = await supabase.from("follows").select("*",{count:"exact",head:true}).eq("follower", userId);
      $.meFollowing.textContent = f2 && typeof f2.count === 'number' ? f2.count : 0;
    }

    async function refreshUI(){
      var user = await getSessionUser();
      if (!user){
        $.loginBox.style.display = "block";
        $.regBox.style.display = "none";
        $.userBox.style.display = "none";
        $.notifList.innerHTML = ""; $.notifBadge.style.display = "none";
        $.notifDropdown.classList.remove('active');
        if (notifChannel) { try{ supabase.removeChannel(notifChannel); }catch(e){} notifChannel = null; }
        await loadPhotos(null); await loadTopUsers();
        return;
      }
      $.loginBox.style.display = "none";
      $.regBox.style.display = "none";
      $.userBox.style.display = "block";
      $.meEmail.textContent = user.email;
      await updateUserPanel(user.id);
      await loadPhotos(currentFilterUserId);
      await loadTopUsers();
      await loadNotifications(user.id);
      subscribeNotifications(user.id);
      await refreshAvatarPreview(user.id);
    }
    supabase.auth.onAuthStateChange(function(){ refreshUI(); });

    // Notifications
    function typeLabel(t){ return t === 'like' ? '‚ù§Ô∏è Beƒüeni' : t === 'comment' ? 'üí¨ Yorum' : '‚ûï Takip'; }
    function fmtTime(iso){ try{ return new Date(iso).toLocaleString(); }catch(e){ return ""; } }

    async function loadNotifications(userId){
      var res = await supabase.from("notifications")
        .select("id,type,message,is_read,created_at,photo_id,comment_id,actor")
        .eq("recipient", userId)
        .order("created_at", { ascending:false })
        .limit(40);
      if (!res || res.error) return;
      var data = res.data || [];

      var actorIds = [];
      for (var i=0;i<data.length;i++){ var a = data[i].actor; if (a && actorIds.indexOf(a)===-1) actorIds.push(a); }
      var nameMap = {};
      if (actorIds.length){
        var p = await supabase.from('user_profiles').select('id,username').in('id', actorIds);
        var arr = p && p.data ? p.data : [];
        for (var j=0;j<arr.length;j++){ nameMap[arr[j].id] = arr[j].username; }
      }

      var unread = 0; for (var k=0;k<data.length;k++){ if (!data[k].is_read) unread++; }
      $.notifBadge.textContent = String(unread);
      $.notifBadge.style.display = unread > 0 ? "inline-flex" : "none";

      var html = '';
      for (var t=0;t<data.length;t++){
        var n = data[t];
        var actorName = nameMap[n.actor] ? '<b>'+escapeHtml(nameMap[n.actor])+'</b> ' : '';
        var msg = n.type === 'like' ? (actorName+'fotoƒürafƒ±nƒ± beƒüendi.')
                : n.type === 'comment' ? (actorName+'yorum yaptƒ±.')
                : (actorName+'seni takip etti.');
        html += '<div class="notifItem '+(n.is_read?'':'unread')+'">'+
                '<div><span>'+typeLabel(n.type)+'</span> ‚Äî '+msg+'</div>'+
                '<div class="small">'+fmtTime(n.created_at)+'</div>'+
                '<div class="row" style="justify-content:flex-end; gap:8px; margin-top:6px;">'+
                (n.photo_id ? '<button class="btn ghost goPhoto" data-id="'+n.photo_id+'">Fotoƒürafa git</button>' : '')+
                (!n.is_read ? '<button class="btn markRead" data-id="'+n.id+'">Okundu ‚úì</button>' : '')+
                '</div></div>';
      }
      $.notifList.innerHTML = html;

      var goBtns = $.notifList.querySelectorAll(".goPhoto");
      for (var g=0; g<goBtns.length; g++){
        goBtns[g].onclick = async function(e){
          var pid = parseInt(e.currentTarget.dataset.id, 10);
          var rp = await supabase.from("photos").select("*").eq("id", pid).single();
          var p = rp && rp.data ? rp.data : null;
          if (p){ currentFilterUserId = null; await loadPhotos(null); map.setView([p.lat, p.lng], 12); $.notifDropdown.classList.remove('active'); }
        };
      }
      var rdBtns = $.notifList.querySelectorAll(".markRead");
      for (var r=0; r<rdBtns.length; r++){
        rdBtns[r].onclick = async function(e){
          var id = parseInt(e.currentTarget.dataset.id, 10);
          await supabase.from("notifications").update({ is_read: true }).eq("id", id);
          await loadNotifications(userId);
        };
      }
    }
    function subscribeNotifications(userId){
      if (notifChannel) { try{ supabase.removeChannel(notifChannel);}catch(e){} }
      notifChannel = supabase.channel('notif:'+userId)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: 'recipient=eq.'+userId }, async function(){ await loadNotifications(userId); })
        .subscribe();
    }
    $.btnReadAll.onclick = async function(){ var me = await getSessionUser(); if (!me) return; await supabase.from("notifications").update({ is_read: true }).eq("recipient", me.id).eq("is_read", false); await loadNotifications(me.id); };
    $.btnNotif.onclick = async function(){ var me = await getSessionUser(); if (!me) return; $.notifDropdown.classList.toggle('active'); if ($.notifDropdown.classList.contains('active')) await loadNotifications(me.id); };
    $.closeNotif.onclick = function(){ $.notifDropdown.classList.remove('active'); };

    // Photos
    var currentFilterUserId = null;
    var pendingLatLng = null;
    var editingPhoto = null;
    var pendingEditLatLng = null;

    async function buildPopup(photo){
      var me = await getSessionUser();
      var lc = await supabase.from("likes").select("*",{count:"exact",head:true}).eq("photo_id", photo.id);
      var likeCount = lc && typeof lc.count === 'number' ? lc.count : 0;

      var liked = false;
      if (me){
        var ml = await supabase.from("likes").select("id").eq("photo_id", photo.id).eq("user_id", me.id).limit(1);
        liked = ml && ml.data && ml.data.length > 0;
      }

      var cr = await supabase.from("comments").select("id, content, created_at, user_id").eq("photo_id", photo.id).order("created_at", { ascending:false }).limit(50);
      var comments = cr && cr.data ? cr.data : [];

      var usernames = {};
      if (comments.length){
        var uids = []; for (var i=0;i<comments.length;i++){ if (uids.indexOf(comments[i].user_id)===-1) uids.push(comments[i].user_id); }
        var profs = await supabase.from("user_profiles").select("id, username").in("id", uids);
        var arr = profs && profs.data ? profs.data : [];
        for (var j=0;j<arr.length;j++){ usernames[arr[j].id] = arr[j].username; }
      }

      var wrap = document.createElement("div");
      wrap.className = "popup";
      wrap.innerHTML =
        '<img src="'+photo.image_url+'" alt="photo" loading="lazy" decoding="async"/>'+
        '<div class="row" style="align-items:center;">'+
          '<div>'+
            '<span class="like" title="beƒüen">'+(liked ? "‚ù§Ô∏è" : "ü§ç")+'</span> '+
            '<span><b>'+likeCount+'</b> likes</span>'+
          '</div>'+
          ((me && me.id === photo.user_id) ? 
            ('<div class="dropdown" style="margin-left:auto;">'+
              '<span class="menu-trigger">‚ãØ</span>'+
              '<div class="dropdown-menu">'+
                '<button class="btnEditPhoto">Konumu/etiketi d√ºzenle</button>'+
              '</div></div>') : '')+
        '</div>'+
        '<div class="comments">'+
          comments.map(function(c){
            return '<div data-id="'+c.id+'">‚Ä¢ <b>'+escapeHtml(usernames[c.user_id]||"?")+
                   '</b>: '+escapeHtml(c.content)+
                   ((me && me.id===c.user_id)?' <a href="#" class="editComment" data-id="'+c.id+'">d√ºzenle</a>':'')+
                   '</div>';
          }).join("")+
        '</div>'+
        '<input type="text" class="commentInput" placeholder="Yorum yaz ve Enter"/>';

      var trig = wrap.querySelector('.menu-trigger');
      if (trig){ var menu = wrap.querySelector('.dropdown-menu'); trig.onclick = function(e){ e.stopPropagation(); menu.classList.toggle('active'); }; }

      var likeBtn = wrap.querySelector(".like");
      likeBtn.onclick = async function(){
        var user = await getSessionUser();
        if (!user) { alert("√ñnce giri≈ü yapƒ±nƒ±z."); return; }
        if (liked) {
          await supabase.from("likes").delete().eq("photo_id", photo.id).eq("user_id", user.id);
        } else {
          await supabase.from("likes").insert({ photo_id: photo.id, user_id: user.id });
          var owner = await supabase.from('user_profiles').select('coin').eq('id', photo.user_id).single();
          if (owner && owner.data) await supabase.from('user_profiles').update({ coin: (owner.data.coin||0) + 5 }).eq('id', photo.user_id);
        }
        await loadPhotos(currentFilterUserId);
      };

      var ci = wrap.querySelector(".commentInput");
      ci.addEventListener("keypress", async function(e){
        if (e.key === "Enter") {
          var user = await getSessionUser();
          if (!user) { alert("√ñnce giri≈ü yapƒ±nƒ±z."); return; }
          var content = ci.value.trim();
          if (!content) return;
          await supabase.from("comments").insert({ photo_id: photo.id, user_id: user.id, content: content });
          ci.value = "";
          await loadPhotos(currentFilterUserId);
        }
      });

      var edits = wrap.querySelectorAll('.editComment');
      for (var x=0;x<edits.length;x++){
        edits[x].onclick = async function(ev){
          ev.preventDefault();
          var id = parseInt(ev.currentTarget.dataset.id,10);
          var txt = window.prompt('Yeni yorum metni:');
          if (txt && txt.trim()) { await supabase.from('comments').update({ content: txt.trim() }).eq('id', id); await loadPhotos(currentFilterUserId); }
        };
      }

      var btnEditPhoto = wrap.querySelector('.btnEditPhoto');
      if (btnEditPhoto){
        btnEditPhoto.onclick = function(){
          editingPhoto = photo; pendingEditLatLng = { lat: photo.lat, lng: photo.lng };
          alert("Konumu g√ºncellemek i√ßin saƒü panelde Photo Settings > ilgili foto'dan 'Konum Se√ß' butonunu da kullanabilirsiniz.");
        };
      }
      return wrap;
    }

    async function loadPhotos(filterUserId){
      clearMarkers();
      var q = supabase.from("photos").select("*").order("id", { ascending: false }).limit(500);
      if (filterUserId) q = q.eq("user_id", filterUserId);
      var r = await q;
      var photos = r && r.data ? r.data : [];
      for (var i=0;i<photos.length;i++){
        var p = photos[i];
        var popup = await buildPopup(p);
        var m = L.marker([p.lat, p.lng], { icon: thumbIcon(p.image_url) }).addTo(map).bindPopup(popup);
        markers.push(m);
      }
    }

    // Top Users + avatars
    async function loadTopUsers(){
      var r = await supabase.from("user_profiles").select("id,username,coin,posts,avatar_url");
      var users = r && r.data ? r.data : [];
      var me = await getSessionUser();
      users.sort(function(a,b){ return (b.coin||0) - (a.coin||0); });
      var top = users.slice(0,10);

      $.topList.innerHTML = "";
      for (var i=0;i<top.length;i++){
        (async function(u){
          var av = u.avatar_url;
          if (!av){
            var fp = await supabase.from("photos").select("image_url").eq("user_id", u.id).order("id", {ascending:true}).limit(1);
            if (fp && fp.data && fp.data.length) av = fp.data[0].image_url;
          }
          if (!av) av = "data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"64\" height=\"64\"><rect width=\"100%\" height=\"100%\" fill=\"#e5e7eb\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"#9ca3af\" font-size=\"14\">?</text></svg>');

          var li = document.createElement("li");
          li.className = "user-item";
          li.innerHTML =
            '<div class="row" style="justify-content:space-between;">'+
              '<div class="user-line"><img class="avatar-sm" src="'+av+'" alt=""><div><b>'+escapeHtml(u.username)+'</b><div class="muted">üí∞ '+(u.coin||0)+' ‚Ä¢ üñºÔ∏è '+(u.posts||0)+'</div></div></div>'+
              '<div>‚Ä∫</div>'+
            '</div>';

          var sub = document.createElement("div");
          sub.className = "submenu";
          sub.innerHTML =
            '<div class="row" style="gap:8px; align-items:center; margin-bottom:6px;">'+
              '<button class="btn followBtn">Follow</button>'+
              '<span class="muted">Followers: <b class="fcount">0</b></span>'+
            '</div>'+
            '<div class="muted">Bu kullanƒ±cƒ±nƒ±n fotoƒüraflarƒ±nƒ± haritada g√∂sterir.</div>';
          li.appendChild(sub);

          li.addEventListener("click", async function(ev){
            if (ev.target.classList.contains("followBtn")) return;
            sub.classList.toggle("active");
            currentFilterUserId = u.id;
            await loadPhotos(currentFilterUserId);
          });

          var fc = await supabase.from("follows").select("*",{count:"exact",head:true}).eq("following", u.id);
          var cnt = fc && typeof fc.count === 'number' ? fc.count : 0;
          sub.querySelector(".fcount").textContent = String(cnt);

          var btn = sub.querySelector(".followBtn");
          if (me){
            var already = await supabase.from("follows").select("id").eq("follower", me.id).eq("following", u.id).limit(1);
            if (already && already.data && already.data.length > 0) btn.textContent = "Following";
            btn.onclick = async function(e){
              e.stopPropagation();
              var meNow = await getSessionUser(); if (!meNow) { alert("√ñnce giri≈ü yapƒ±nƒ±z."); return; }
              if (btn.textContent === "Follow") {
                var ins = await supabase.from("follows").insert({ follower: meNow.id, following: u.id });
                if (!ins.error) {
                  btn.textContent = "Following";
                  sub.querySelector(".fcount").textContent = String(parseInt(sub.querySelector(".fcount").textContent||"0",10)+1);
                  await updateUserPanel(meNow.id);
                  var prof = await supabase.from('user_profiles').select('coin').eq('id', u.id).single();
                  if (prof && prof.data) await supabase.from('user_profiles').update({ coin: (prof.data.coin||0) + 10 }).eq('id', u.id);
                }
              } else {
                var del = await supabase.from("follows").delete().eq("follower", meNow.id).eq("following", u.id);
                if (!del.error) {
                  btn.textContent = "Follow";
                  sub.querySelector(".fcount").textContent = String(Math.max(0,(parseInt(sub.querySelector(".fcount").textContent||"0",10)-1)));
                  await updateUserPanel(meNow.id);
                }
              }
            };
          } else {
            btn.onclick = function(e){ e.stopPropagation(); alert("Follow i√ßin giri≈ü yapƒ±n."); };
          }
          $.topList.appendChild(li);
        })(top[i]);
      }
    }

    // Sol panel kullanƒ±cƒ± arama
    $.searchUser.addEventListener("input", async function(e){
      var term = e.target.value.trim();
      if (!term) { $.searchResults.innerHTML = ""; return; }
      var r = await supabase.from("user_profiles").select("id, username, posts, avatar_url").ilike("username", "%"+term+"%").limit(12);
      var users = r && r.data ? r.data : [];
      var html = '';
      for (var i=0;i<users.length;i++){
        var u = users[i], av = u.avatar_url;
        if (!av){
          var fp = await supabase.from("photos").select("image_url").eq("user_id", u.id).order("id", {ascending:true}).limit(1);
          if (fp && fp.data && fp.data.length) av = fp.data[0].image_url;
        }
        if (!av) av = "data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"64\" height=\"64\"><rect width=\"100%\" height=\"100%\" fill=\"#e5e7eb\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"#9ca3af\" font-size=\"14\">?</text></svg>');
        html += '<li class="user-item" data-id="'+u.id+'"><div class="user-line"><img class="avatar-sm" src="'+av+'"><b>'+escapeHtml(u.username)+'</b> <span class="muted">‚Ä¢ '+(u.posts||0)+' post</span></div></li>';
      }
      $.searchResults.innerHTML = html;
      var items = $.searchResults.querySelectorAll(".user-item");
      for (var k=0;k<items.length;k++){
        items[k].onclick = async function(){ currentFilterUserId = this.dataset.id; await loadPhotos(currentFilterUserId); };
      }
    });
    // Add Photo (modal)
    $.addPhoto.onclick = async function(){
      var user = await getSessionUser(); if (!user) { alert("√ñnce giri≈ü yapƒ±nƒ±z."); return; }
      pendingLatLng = map.getCenter();
      $.chosenLoc.textContent = "Konum: "+pendingLatLng.lat.toFixed(5)+", "+pendingLatLng.lng.toFixed(5);
      $.uploadErr.textContent = ""; $.fileInput.value = ""; $.previewWrap.innerHTML = ""; $.previewWrap.style.display = "none";
      setModal(true);
    };
    $.pickOnMap.onclick = function(){
      $.photoForm.classList.remove('active'); $.overlay.classList.remove('active'); $.hint.classList.add("active");
      var onClick = function(e){ pendingLatLng = e.latlng; $.chosenLoc.textContent = "Konum: "+pendingLatLng.lat.toFixed(5)+", "+pendingLatLng.lng.toFixed(5); $.hint.classList.remove("active"); map.off("click", onClick); setModal(true); };
      map.once("click", onClick);
    };
    $.fileInput.onchange = function(){ var f = $.fileInput.files && $.fileInput.files[0]; if (f){ $.previewWrap.style.display="block"; $.previewWrap.innerHTML='<img src="'+URL.createObjectURL(f)+'" style="width:100%;border-radius:12px;margin-top:6px;" loading="lazy" decoding="async">'; } };
    $.cancelUpload.onclick = function(){ setModal(false); pendingLatLng = null; };
    $.confirmUpload.onclick = async function(){
      try{
        $.uploadErr.textContent = "";
        var user = await getSessionUser(); if (!user) { alert("√ñnce giri≈ü yapƒ±nƒ±z."); return; }
        if (!pendingLatLng) { pendingLatLng = map.getCenter(); }
        var f = $.fileInput.files && $.fileInput.files[0]; if (!f){ $.uploadErr.textContent="L√ºtfen fotoƒüraf se√ßin."; return; }
        f = await compressImageIfNeeded(f, 1920, 2);
        var ext = (f.name.split(".").pop() || "jpg"); var path = user.id + "/" + Date.now() + "." + ext;
        var up = await supabase.storage.from("photos").upload(path, f); if (up && up.error){ $.uploadErr.textContent="Y√ºkleme hatasƒ±: "+up.error.message; return; }
        var pub = supabase.storage.from("photos").getPublicUrl(path); var imageUrl = pub && pub.data ? pub.data.publicUrl : null; if (!imageUrl){ $.uploadErr.textContent="Public URL olu≈üturulamadƒ±."; return; }
        var ins = await supabase.from("photos").insert({ user_id: user.id, lat: pendingLatLng.lat, lng: pendingLatLng.lng, image_url: imageUrl }); if (ins && ins.error){ $.uploadErr.textContent="DB hata: "+ins.error.message; return; }
        var pr = await supabase.from("user_profiles").select("coin,posts,avatar_url").eq("id", user.id).single();
        if (pr && pr.data){ if (!pr.data.avatar_url){ await supabase.from('user_profiles').update({ avatar_url: imageUrl }).eq('id', user.id); } await supabase.from("user_profiles").update({ coin: (pr.data.coin||0)+10, posts: (pr.data.posts||0)+1 }).eq("id", user.id); }
        setModal(false); pendingLatLng=null; await updateUserPanel(user.id); await loadPhotos(currentFilterUserId); await refreshAvatarPreview(user.id); alert("Fotoƒüraf y√ºklendi!");
      }catch(e){ $.uploadErr.textContent="Beklenmeyen hata: "+(e&&e.message?e.message:e); }
    };

    // Saƒü panel: Profile Settings toggle
    $.toggleProfileSettings.onclick = function(){ $.profileSettingsSection.classList.toggle('hidden'); };
    $.togglePhotoSettings.onclick   = async function(){
      $.photoSettingsSection.classList.toggle('hidden');
      if (!$.photoSettingsSection.classList.contains('hidden')) { await renderPhotoSettings(); }
    };

    // Profile save
    $.btnTogglePass.onclick = function(){ var d=$.newPass.disabled; $.newPass.disabled=!d; $.newPass2.disabled=!d; if(!d){ $.newPass.value=''; $.newPass2.value=''; } };
    $.saveEdit.onclick = async function(){
      $.editErr.textContent = "";
      var me = await getSessionUser(); if (!me) { $.editErr.textContent="√ñnce giri≈ü yapƒ±n."; return; }
      var newName = $.editUsername.value.trim();
      var avatarFile = $.editAvatar.files && $.editAvatar.files[0];
      var np1 = $.newPass.value.trim(), np2 = $.newPass2.value.trim();
      if (np1 || np2){ if (np1.length<8){ $.editErr.textContent='≈ûifre en az 8 karakter olmalƒ±.'; return; } if (np1!==np2){ $.editErr.textContent='≈ûifreler e≈üle≈ümiyor.'; return; } var pu=await supabase.auth.updateUser({password:np1}); if(pu&&pu.error){ $.editErr.textContent=pu.error.message; return; } }
      var updates = {}; if (newName) updates.username = newName;
      if (avatarFile){ var f = await compressImageIfNeeded(avatarFile, 1024, 1.5); var ext=f.name.split('.').pop()||'jpg'; var avatarPath='avatars/'+me.id+'.'+ext; var up=await supabase.storage.from('avatars').upload(avatarPath,f,{upsert:true}); if(!up||!up.error){ var pub=supabase.storage.from('avatars').getPublicUrl(avatarPath); var url=pub&&pub.data?pub.data.publicUrl:null; if(url) updates.avatar_url=url; } }
      var upUser = await supabase.from('user_profiles').update(updates).eq('id', me.id); if (upUser && upUser.error){ if (upUser.error.message && upUser.error.message.toLowerCase().indexOf('avatar_url')>-1){ delete updates.avatar_url; var up2 = await supabase.from('user_profiles').update(updates).eq('id', me.id); if(up2&&up2.error){ $.editErr.textContent=up2.error.message; return; } } else { $.editErr.textContent=upUser.error.message; return; } }
      await refreshUI(); alert('Profil g√ºncellendi.');
    };

    // Photo Settings (right panel i√ßi)
    async function renderPhotoSettings(){
      var me = await getSessionUser(); if (!me){ $.psList.innerHTML='<div class="muted">Oturum gerekli.</div>'; return; }
      var r = await supabase.from('photos').select('id,image_url,lat,lng').eq('user_id', me.id).order('id',{ascending:false});
      var ph = r && r.data ? r.data : [];
      if (!ph.length){ $.psList.innerHTML='<div class="muted">Hen√ºz fotoƒüraf yok.</div>'; return; }
      var html = '';
      for (var i=0;i<ph.length;i++){
        var p = ph[i];
        html += '<div style="display:flex;gap:10px;align-items:center;border:1px solid #eee;border-radius:10px;padding:8px;margin-bottom:8px;">'+
                '<img src="'+p.image_url+'" style="width:64px;height:64px;object-fit:cover;border-radius:8px;" loading="lazy" decoding="async"/>'+
                '<div style="flex:1;"><div>ID: <b>'+p.id+'</b></div><div class="muted">Lat: '+p.lat.toFixed(5)+' Lng: '+p.lng.toFixed(5)+'</div></div>'+
                '<div class="row" style="gap:6px;flex-wrap:wrap;">'+
                  '<button class="btn ghost" data-ps-go="'+p.id+'">G√∂ster</button>'+
                  '<button class="btn" data-ps-pick="'+p.id+'">Konum Se√ß</button>'+
                  '<button class="btn" style="border-color:#f3c;color:#c00;" data-ps-del="'+p.id+'">Sil</button>'+
                '</div>'+
              '</div>';
      }
      $.psList.innerHTML = html;

      // G√∂ster
      $.psList.querySelectorAll('[data-ps-go]').forEach(function(b){
        b.onclick = async function(){ var id=parseInt(b.getAttribute('data-ps-go'),10); var p=await supabase.from('photos').select('*').eq('id',id).single(); if (p&&p.data){ currentFilterUserId=null; await loadPhotos(null); map.setView([p.data.lat,p.data.lng], 13); } };
      });
      // Konum se√ß (map click)
      $.psList.querySelectorAll('[data-ps-pick]').forEach(function(b){
        b.onclick = async function(){
          var id = parseInt(b.getAttribute('data-ps-pick'),10);
          var pr = await supabase.from('photos').select('*').eq('id',id).single(); var p = pr&&pr.data?pr.data:null; if(!p) return;
          $.hint.classList.add("active");
          var onClick = async function(e){
            $.hint.classList.remove("active"); map.off("click", onClick);
            var updates = { lat: e.latlng.lat, lng: e.latlng.lng };
            var up = await supabase.from('photos').update(updates).eq('id', id);
            if (!up.error){ await loadPhotos(currentFilterUserId); await renderPhotoSettings(); map.setView([updates.lat,updates.lng], 14); }
          };
          map.once("click", onClick);
        };
      });
      // Sil
      $.psList.querySelectorAll('[data-ps-del]').forEach(function(b){
        b.onclick = async function(){
          var id=parseInt(b.getAttribute('data-ps-del'),10);
          if (!confirm('Fotoƒüraf silinsin mi?')) return;
          await supabase.from('photos').delete().eq('id', id);
          var me2 = await getSessionUser();
          var prof = await supabase.from('user_profiles').select('posts').eq('id', me2.id).single();
          if (prof && prof.data) await supabase.from('user_profiles').update({ posts: Math.max(0,(prof.data.posts||0)-1) }).eq('id', me2.id);
          await loadPhotos(currentFilterUserId);
          await renderPhotoSettings();
        };
      });
    }

    // Auth (login/register/logout)
    $.showRegister.onclick = function(){ $.loginBox.style.display="none"; $.regBox.style.display="block"; };
    $.showLogin.onclick = function(){ $.regBox.style.display="none"; $.loginBox.style.display="block"; };
    $.btnRegister.onclick = async function(){
      $.regErr.textContent=""; var email=$.regEmail.value.trim(), pass=$.regPass.value.trim(); if(!email||!pass){ $.regErr.textContent="Email ve ≈üifre gerekli."; return; }
      var r = await supabase.auth.signUp({ email:email, password:pass, options:{ email_confirm:false } }); if(r&&r.error){ $.regErr.textContent=r.error.message; return; }
      var user = r&&r.data?r.data.user:null; if(user){ var i=await supabase.from("user_profiles").insert({ id:user.id, username:email, coin:0, posts:0 }); if(i&&i.error) console.warn(i.error.message); }
      alert("Kayƒ±t ba≈üarƒ±lƒ±! ≈ûimdi giri≈ü yapƒ±n."); $.regBox.style.display="none"; $.loginBox.style.display="block";
    };
    $.btnLogin.onclick = async function(){
      $.loginErr.textContent=""; var email=$.loginEmail.value.trim(), pass=$.loginPass.value.trim();
      var r = await supabase.auth.signInWithPassword({ email:email, password:pass }); if(r&&r.error){ $.loginErr.textContent=r.error.message; return; }
      var user = r&&r.data?r.data.user:null; if(user){ var p=await supabase.from("user_profiles").select("id").eq("id",user.id).single(); if(!p||p.error){ await supabase.from("user_profiles").insert({ id:user.id, username:email, coin:0, posts:0 }); } }
      await refreshUI();
    };
    $.btnLogout.onclick = async function(){ await supabase.auth.signOut(); await refreshUI(); };

    // Map search (Nominatim)
    async function nominatimSearch(q){
      var url = "https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(q)+"&limit=8";
      var res = await fetch(url, { headers: { "Accept":"application/json" } });
      if (!res.ok) return [];
      return await res.json();
    }
    $.mapSearchBtn.onclick = async function(){
      var q = $.mapSearchInput.value.trim(); if (!q) return;
      var data = await nominatimSearch(q);
      if (!data || !data.length){ $.mapSearchResults.innerHTML='<div>Sonu√ß bulunamadƒ±</div>'; $.mapSearchResults.classList.add('active'); return; }
      $.mapSearchResults.innerHTML = data.map(function(it){ return '<div data-lat="'+it.lat+'" data-lon="'+it.lon+'">'+escapeHtml(it.display_name)+'</div>'; }).join('');
      $.mapSearchResults.classList.add('active');
      $.mapSearchResults.querySelectorAll('div').forEach(function(el){
        el.onclick = function(){
          var lat=parseFloat(el.getAttribute('data-lat')), lon=parseFloat(el.getAttribute('data-lon'));
          $.mapSearchResults.classList.remove('active');
          map.setView([lat,lon], 14);
          L.marker([lat,lon]).addTo(map);
        };
      });
    };
    $.mapSearchInput.addEventListener('keydown', function(e){ if (e.key==='Enter'){ $.mapSearchBtn.click(); } });
    document.addEventListener('click', function(e){ if (!e.target.closest || !e.target.closest('.map-search')) $.mapSearchResults.classList.remove('active'); });

    // Mobile nav toggle
    var sidebarEl = document.querySelector('.sidebar'); var rightEl = document.querySelector('.right');
    document.querySelector('#menuToggle').onclick = function(){ if (sidebarEl.classList.contains('active') || rightEl.classList.contains('active')){ sidebarEl.classList.remove('active'); rightEl.classList.remove('active'); } else { sidebarEl.classList.add('active'); } };
    $.homeBtn.onclick = async function(){ currentFilterUserId = null; await loadPhotos(null); };
    $.refreshBtn.onclick = async function(){ await refreshUI(); };

    // Init
    refreshUI();

    // Service Worker sadece http/https
    if ((location.protocol==="http:" || location.protocol==="https:") && "serviceWorker" in navigator){
      navigator.serviceWorker.register("service-worker.js").catch(function(){});
    }

    // PWA Install Prompt (banner)
    (function(){
      var banner = document.createElement('div'); banner.id='installBanner'; banner.className='row'; banner.style.display='none';
      banner.innerHTML = '<button id="btnInstall" class="btn primary">üì± Ana Ekrana Ekle</button>'; document.body.appendChild(banner);
      var deferredPrompt=null;
      window.addEventListener("beforeinstallprompt", function(e){ e.preventDefault(); deferredPrompt=e; banner.style.display="block"; });
      document.addEventListener('click', function(e){ if(e.target && e.target.id==='btnInstall' && deferredPrompt){ banner.style.display='none'; deferredPrompt.prompt(); deferredPrompt.userChoice.then(function(){ deferredPrompt=null; }); } });
      var isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent); var isStandalone=(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||window.navigator.standalone;
      if (isIOS && !isStandalone){ var tip=document.createElement('div'); tip.style.position='fixed'; tip.style.left='50%'; tip.style.transform='translateX(-50%)'; tip.style.bottom='20px'; tip.style.zIndex='3500'; tip.style.background='#111'; tip.style.color='#fff'; tip.style.padding='8px 12px'; tip.style.borderRadius='999px'; tip.textContent='‚ûï Payla≈ü ‚Ä∫ Ana Ekrana Ekle'; document.body.appendChild(tip); setTimeout(function(){ try{ tip.remove(); }catch(e){} }, 8000); }
    })();
  </script>
</body>
</html>
