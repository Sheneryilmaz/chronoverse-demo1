<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>ChronoVerse</title>

  <!-- PWA meta -->
  <meta name="theme-color" content="#2a7aee">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="icon.png"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Supabase v2 (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <style>
    :root{
      --panelW: 20vw;
      --panelMin: 220px;
      --panelMax: 360px;
      --panelBg: rgba(255,255,255,.80);
      --panelBgHover: rgba(255,255,255,.95);
      --panelBlur: 8px;
    }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family: Inter, Arial, sans-serif; background:#fff; }
    .app { display:flex; height:100vh; width:100vw; }

   .sidebar, .right {
  width: 300px;
  min-width: 250px;
  max-width: 380px;
  background-color: rgba(255, 255, 255, 0.4) !important; /* Daha şeffaf */
  -webkit-backdrop-filter: blur(18px) saturate(180%) !important; /* iPhone uyumlu blur */
  backdrop-filter: blur(18px) saturate(180%) !important;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
  padding:14px;
  overflow-y:auto;
  transition: transform .3s ease-in-out;
}

/* Sağ panelin görünümünü modernize ediyoruz */
.right {
  background: rgba(255, 255, 255, 0.9) !important;
  backdrop-filter: blur(12px) saturate(180%);
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  border-left: 1px solid rgba(255, 255, 255, 0.25);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.section {
  background: #fff;
  border-radius: 14px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
  padding: 12px;
  margin-bottom: 12px;
}
.photo-card {
  display: flex;
  gap: 12px;
  padding: 10px;
  border-radius: 14px;
  border: 1px solid #eaeaea;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  transition: box-shadow .2s ease-in-out;
  margin-bottom: 10px;
}
.photo-card:hover {
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}
.photo-thumb {
  width: 72px;
  height: 72px;
  object-fit: cover;
  border-radius: 10px;
}
.photo-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}
.photo-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.photo-actions .edit-btn {
  background: #eef5ff;
  border: 1px solid #c6dbff;
  color: #1a73e8;
}
.photo-actions .del-btn {
  background: #ffefef;
  border: 1px solid #f8c6c6;
  color: #c62828;
}

    .sidebar:hover, .right:hover { background: var(--panelBgHover); }
    .right { border-right:none; border-left:1px solid #e5e5e5; }
    .mapwrap { flex:1; position:relative; display:flex; flex-direction:column; }
    #map { flex:1; }

    .row { display:flex; align-items:center; gap:8px; }
    .btn { padding:8px 10px; border:1px solid #d8dbe2; border-radius:10px; cursor:pointer; background:#f7f8fc; }
    .btn.primary { background:#2a7aee; border-color:#2a7aee; color:#fff; }
    .btn.ghost { background:#fff; }
    .error { color:#d33; font-size:13px; margin-top:6px; }
    .title { margin:0 0 10px 0; }
    ul { list-style:none; margin:0; padding:0; }
    .user-item { padding:8px; border-radius:10px; cursor:pointer; }
    .user-item:hover { background:#f4f6fb; }
    .submenu { display:none; padding:8px; background:#fafafa; border:1px solid #eee; border-radius:10px; margin-top:6px; }
    .submenu.active { display:block; }
    .muted { color:#666; font-size:13px; }
    .kpi { margin:4px 0; }
    .badge { display:inline-flex; align-items:center; justify-content:center; min-width:20px; height:20px; border-radius:999px; background:#e11d48; color:#fff; font-size:12px; padding:0 6px; }

    /* Popups & thumbnails */
    .popup { width:280px; }
    .popup img { width:100%; border-radius:12px; margin-bottom:6px; }
    .popup .like { cursor:pointer; font-size:18px; user-select:none; }
    .popup .comments { max-height:160px; overflow:auto; border-top:1px solid #eee; margin-top:6px; padding-top:6px; font-size:13px; }
    .popup .menu-trigger { margin-left:auto; cursor:pointer; font-size:18px; }

    .thumb-marker { width:42px; height:42px; border-radius:10px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,.22); border:2px solid #fff; }
    .thumb-marker img { width:100%; height:100%; object-fit:cover; display:block; }

    /* Map hint + overlay + modals */
    .hint { position:absolute; top:10px; left:50%; transform:translateX(-50%); background:#111; color:#fff; padding:6px 10px; border-radius:999px; font-size:12px; display:none; z-index:500; }
    .hint.active { display:inline-block; }

    .overlay { position:absolute; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,.32); z-index:1000; display:none; }
    .overlay.active { display:block; }

    .photo-form {
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:#fff; border-radius:14px; box-shadow:0 14px 36px rgba(0,0,0,.18);
      padding:16px; width:360px; z-index:1001; display:none;
    }
    .photo-form.active { display:block; }

    /* Dropdown */
    .dropdown { position:relative; }
    .dropdown-menu { position:absolute; right:0; top:28px; background:#fff; border:1px solid #eaeaea; border-radius:12px; box-shadow:0 12px 30px rgba(0,0,0,.14); display:none; min-width:200px; z-index:1200; }
    .dropdown-menu.active { display:block; }
    .dropdown-menu button { width:100%; text-align:left; padding:10px 12px; border:0; background:#fff; cursor:pointer; border-radius:10px; }
    .dropdown-menu button:hover { background:#f7f8fc; }

    /* Notifications dropdown */
    .notifWrap { position:relative; }
    /* eski: right:0; top:40px; width:320px; ... */
.notifDropdown{
  position: absolute;
  left: 0;            /* ekle */
  right: 0;           /* ekle */
  top: 40px;
  width: 100%;        /* 320px yerine bu */
  max-height: min(60vh, 520px);
  overflow: auto;
  background: #fff;
  border: 1px solid #eaeaea;
  border-radius: 14px;
  box-shadow: 0 12px 30px rgba(0,0,0,.14);
  display: none;
  box-sizing: border-box; /* taşmaları önlemek için */
}
.notifDropdown.active { display:block; }
    .notifItem { padding:10px 12px; border-bottom:1px solid #f1f1f1; }
    .notifItem:last-child { border-bottom:0; }

    /* Sağ panel içi bölümler */
    .section { border:1px dashed #e0e0e0; border-radius:12px; padding:12px; margin:10px 0; }
    .section.hidden { display:none; }

    /* Feature grid */
    .featureBtns { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px; }

    /* Map search box (top-right) */
    .map-search {
      position:absolute; right:10px; top:10px; z-index:700;
      background:rgba(255,255,255,.92); backdrop-filter: blur(8px);
      border:1px solid #e5e5e5; border-radius:12px; padding:8px; display:flex; gap:6px; align-items:center;
      width:min(320px, 60vw);
    }
    .map-search input { flex:1; padding:8px; border:1px solid #d8dbe2; border-radius:8px; }
    .map-search .results { position:absolute; right:0; top:46px; background:#fff; border:1px solid #e5e5e5; border-radius:10px; width:100%; max-height:50vh; overflow:auto; display:none; }
    .map-search .results.active { display:block; }
    .map-search .results div { padding:8px 10px; cursor:pointer; }
    .map-search .results div:hover { background:#f7f8fc; }

    /* Avatarlı kullanıcı listesi */
    .user-line { display:flex; gap:8px; align-items:center; }
    .avatar-sm { width:22px; height:22px; border-radius:50%; object-fit:cover; background:#eee; border:1px solid #fff; }

    /* Mobile */
    #menuToggle {
      display:none; position:absolute; top:10px; left:10px; z-index:3000; background:#fff; padding:8px 10px;
      border-radius:12px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,.2);
    }
    @media (max-width:1024px){ :root{ --panelW: 26vw; } }
    @media (max-width:900px){ :root{ --panelW: 30vw; --panelMax: 330px; } }
    @media (max-width:768px) {
  #menuToggle { display:block; }
  .sidebar, .right {
    position:absolute; top:0; bottom:0; width:88%; z-index:2000;
    transform:translateX(-100%);
    transition:transform .28s ease-in-out;
    background:#fff;
  }
  .sidebar.active { transform:translateX(0); }
  .right.active { transform:translateX(0); right:0; left:auto; }
  .right { z-index: 2500; }
}
/* ====== HAMBURGER: Sağ panel aç/kapa (mobil) ====== */
.right-menu-btn {
  position: fixed;
  top: 12px;
  right: 12px;
  width: 42px;
  height: 42px;
  border-radius: 8px;
  background: rgba(255,255,255,0.85);
  color: #111;
  font-size: 22px;
  font-weight: bold;
  border: 1px solid #ccc;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  z-index: 5000;
  cursor: pointer;
  display: none; /* masaüstünde gizli */
}

/* Mobilde buton görünür, sağ panel kayarak açılır */
@media (max-width: 768px) {
  .right-menu-btn {
    display: flex !important;
    align-items: center;
    justify-content: center;
  }
  .right {
    position: fixed !important;
    top: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 85% !important;
    max-width: 420px !important;
    background: rgba(255,255,255,0.9) !important;
    -webkit-backdrop-filter: blur(10px) !important; /* iPhone için */
    backdrop-filter: blur(10px) !important;
    transform: translateX(100%) !important; /* kapalı başlasın */
    transition: transform .3s ease-in-out !important;
    z-index: 4000 !important;
    overflow: auto; /* içerik kaydırılabilir olsun */
  }
  .right.active {
    transform: translateX(0) !important; /* açıldığında ekrana gelsin */
  }
}
/* Profil Ayarları */
.profile-avatar-wrap {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  margin-bottom: 12px;
}
.profile-avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #ddd;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
  transition: transform 0.2s ease-in-out;
}

/* Hover'da hafif büyütme efekti */
.profile-avatar:hover {
  transform: scale(1.05);
}

.avatar-upload-btn {
  padding: 4px 10px;
  background: #f7f8fc;
  border: 1px solid #d8dbe2;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  transition: background .2s ease-in-out;
}
.avatar-upload-btn:hover {
  background: #eef1ff;
}

.profile-input-wrap {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 12px;
}
.profile-input-wrap label {
  font-size: 13px;
  color: #444;
}
.profile-input-wrap input {
  padding: 8px;
  border: 1px solid #d8dbe2;
  border-radius: 8px;
  font-size: 14px;
  background: #fff;
}

.profile-save-wrap {
  display: flex;
  justify-content: flex-end;
  margin-top: 10px;
}

.small-btn {
  padding: 5px 8px !important;
  font-size: 12px !important;
}
/* ==== Notifications - modern timeline ==== */
.notifDropdown {
  border: 1px solid #ececec;
  border-radius: 14px;
  overflow: hidden;
  background: #fff;
}

.notifHeader {
  position: sticky;
  top: 0;
  background: #f8faff;
  border-bottom: 1px solid #eef1f6;
  padding: 10px 12px;
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: space-between;
  z-index: 1;
}

.notifHeader .actions { display: flex; gap: 8px; }

#notifList {
  padding: 6px 0;
}

.notifGroupDate {
  margin: 6px 12px 8px;
  font-size: 12px;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: .04em;
}

.notifItem {
  padding: 10px 12px;
  display: grid;
  grid-template-columns: 1fr auto;
  gap: 8px;
  border-bottom: 1px solid #f1f3f6;
}

.notifItem:last-child { border-bottom: 0; }

.notifMain { display: flex; gap: 8px; align-items: flex-start; }
.notifType {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 999px;
  font-size: 12px;
  border: 1px solid #e6e6e6;
  background: #fafafa;
  white-space: nowrap;
}

.notifMsg { font-size: 14px; color: #111; }
.notifTime { font-size: 12px; color: #6b7280; }

.notifActions { display: flex; gap: 6px; align-items: center; }
.notifActions .btn { padding: 6px 8px; font-size: 12px; }

.notifItem.unread {
  background: #fffdfa;
}
.notifItem.unread .notifType {
  border-color: #f7e2b7;
  background: #fff3c4;
}

#notifBadge {
  min-width: 18px;
  height: 18px;
  font-size: 11px;
  padding: 0 6px;
}

/* küçük ekranlarda dropdown daha geniş nefes alsın */
@media (max-width: 768px) {
  .notifDropdown { width: min(92vw, 420px); right: 8px; }
}
/* ==== Top Users - modern cards ==== */
#topList { display: grid; grid-template-columns: 1fr; gap: 10px; }
@media (min-width: 420px){ #topList { grid-template-columns: 1fr; } }

.user-card {
  display: grid;
  grid-template-columns: 42px 1fr auto;
  gap: 10px;
  align-items: center;
  padding: 10px;
  border: 1px solid #eaeaea;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 2px 10px rgba(0,0,0,.06);
  transition: box-shadow .2s ease;
}
.user-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,.12); }

.user-avatar {
  width: 42px; height: 42px; border-radius: 50%;
  object-fit: cover; border: 1px solid #eee;
}

.user-meta { display: flex; flex-direction: column; gap: 3px; min-width: 0; }
.user-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-stats { display: flex; gap: 8px; font-size: 12px; color: #666; }
.user-stat { display: inline-flex; gap: 4px; align-items: center; }

.user-actions { display: flex; gap: 6px; }
.user-actions .btn { padding: 6px 8px; font-size: 12px; border-radius: 8px; }
.user-actions .follow { background: #eef5ff; border: 1px solid #cfe1ff; }
.user-actions .following { background: #f1fff2; border: 1px solid #cdeccf; }

.user-skel {
  height: 64px; border-radius: 12px; background: linear-gradient(90deg,#f4f5f7 0%,#f9f9fb 50%,#f4f5f7 100%);
  animation: skel 1.2s ease-in-out infinite; border: 1px solid #eee;
}
@keyframes skel { 0%{background-position:-200px 0} 100%{background-position:200px 0} }
.me-header { 
  display:flex; 
  align-items:center; 
  gap:10px; 
  margin: 6px 0 8px; 
}
.me-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #e5e5e5;
}
/* === Sidebar stabilizer === */
.app { display: flex; }

.sidebar {
  position: relative;
  z-index: 1500;           /* sağdaki öğeler üstüne çıkmasın */
  display: flex;
  flex-direction: column;
  gap: 10px;
  flex: 0 0 300px;         /* genişliği sabitle */
  min-width: 250px;
  max-width: 380px;
}

.mapwrap { 
  flex: 1 1 auto;
  min-width: 0;            /* grid taşmalarını engeller */
}

.right { 
  flex: 0 0 300px;         /* sağ panelin de genişliğini sabitle */
}

#topList, #searchResults { width: 100%; }
/* Masaüstünde sidebar asla saklı kalmasın */
@media (min-width: 769px) {
  .sidebar { transform: none !important; }
  .right   { transform: none !important; }
}
.user-name { 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  max-width: 100%;
}
/* ==== Top Users overlap fix ==== */
#topList { display: grid; grid-template-columns: 1fr; gap: 10px; }

#topList .user-card {
  display: grid;
  grid-template-columns: 42px 1fr;       /* 2 sütun: avatar + içerik */
  grid-template-rows: auto auto;         /* 2 satır: meta + actions */
  grid-template-areas:
    "ava meta"
    "ava actions";
  align-items: center;
  column-gap: 10px;
}

#topList .user-avatar { grid-area: ava; }
#topList .user-meta   { grid-area: meta; min-width: 0; }
#topList .user-actions{
  grid-area: actions;
  justify-content: flex-start;
  flex-wrap: wrap;                        /* dar alanda alta sark */
  gap: 8px;
}

#topList .user-name { 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
}

@media (min-width: 520px){
  /* Geniş panelde eski yatay düzene dön (isteğe bağlı) */
  #topList .user-card{
    grid-template-columns: 42px 1fr auto;
    grid-template-rows: auto;
    grid-template-areas: "ava meta actions";
  }
  #topList .user-actions{ justify-content: flex-end; }
}

/* ==== Top Users layout reset (override) ==== */
#topList {
  display: flex !important;
  flex-direction: column !important;
  gap: 10px !important;
}

#topList > li { list-style: none; }

#topList > li .user-card {
  display: grid !important;
  grid-template-columns: 42px 1fr !important;
  grid-template-rows: auto auto !important;
  grid-template-areas:
    "ava meta"
    "ava actions" !important;
  align-items: center !important;
  column-gap: 10px !important;
}

#topList .user-avatar { grid-area: ava !important; }
#topList .user-meta   { grid-area: meta !important; min-width: 0 !important; }
#topList .user-actions{
  grid-area: actions !important;
  display: flex !important;
  gap: 8px !important;
  flex-wrap: wrap !important;
  justify-content: flex-start !important;
  margin-top: 4px !important;
  position: static !important;   /* olası mutlak konumlandırmayı sıfırla */
  z-index: auto !important;
}

#topList .user-name{
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  max-width: 100% !important;
}
.user-actions .btn { max-width: 100%; }              /* dar alanda taşmasın */
.user-stats { flex-wrap: wrap; }                      /* ikonlar sıkışmasın */

/* Harita altı buton alanı */
.map-footer{
  padding: 10px;
  border-top: 1px solid #e5e5e5;
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(8px);
}
.map-footer .btn{ width: 100%; }

#topList .user-avatar{
  width: 63px !important;
  height: 63px !important;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #eee;
}

/* Kart ızgarasında sol sütunu yeni genişliğe göre ayarla */
#topList .user-card{
  grid-template-columns: 63px 1fr !important;
}

/* Sol panel: arama sonuçlarındaki küçük avatarlar (%50 artış: 22→33) */
.avatar-sm{
  width: 33px !important;
  height: 33px !important;
  border-radius: 50%;
  object-fit: cover;
}

/* Sağ panel: header’daki küçük avatar (%50 artış: 36→54) */
.me-avatar{
  width: 75px !important;
  height: 75px !important;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #e5e5e5;
}

/* Sağ panel: Profile Settings içindeki büyük avatar (%50 artış: 56→84) */
.profile-avatar{
  width: 84px !important;
  height: 84px !important;
  border-radius: 50%;
  object-fit: cover;
  border: 1px solid #ddd;
}
/* Timeline bar */
.timeline.hidden { display: none; }
.timeline {
  border-top: 1px solid #e5e5e5;
  background: rgba(255,255,255,.92);
  backdrop-filter: blur(6px);
  padding: 10px;
  max-height: 220px;
  overflow: auto;                 /* hem yatay hem dikey kaydırma */
}

/* Gün grubu */
.tl-day { margin-bottom: 10px; }
.tl-date {
  font-size: 12px;
  color: #6b7280;
  margin: 4px 0 6px 4px;
}
.tl-strip {
  display: flex;
  gap: 8px;
  overflow-x: auto;
  padding-bottom: 6px;
}
.tl-thumb {
  width: 84px; height: 60px;
  border-radius: 8px;
  object-fit: cover;
  border: 1px solid #eaeaea;
  cursor: pointer;
}
.tl-thumb:hover { transform: translateY(-1px); }

/* Photo Settings içi tarih alanı */
.ps-date-row {
  display:flex; gap:6px; align-items:center; margin-top:6px; flex-wrap:wrap;
}
.ps-date-row input[type="date"]{
  padding:6px 8px; border:1px solid #d8dbe2; border-radius:8px; font-size:13px;
}
/* === Panel Overlay (menüler için) === */
.panel-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.25);
  z-index: 1800; /* sidebar(2000) altında, map üstünde */
}
.panel-overlay.active { display: block; }

/* === iOS ghost blur fix + güvenli kapatma === */
@media (max-width: 768px){
  .sidebar{
    position: fixed !important;
    top: 0 !important; bottom: 0 !important; left: 0 !important;
    width: 85% !important; max-width: 420px !important;
    transform: translateX(-105%) !important;
    opacity: 0 !important;
    pointer-events: none !important;
    transition: transform .28s ease, opacity .28s ease !important;
    z-index: 2000 !important;
    will-change: transform, opacity;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    -webkit-transform: translateZ(0);
  }
  .sidebar.active{
    transform: translateX(0) !important;
    opacity: 1 !important;
    pointer-events: auto !important;
  }

  /* sağ panel zaten fixed; overlay ile uyum için kapanınca tıklanamaz olsun */
  .right{
    pointer-events: none;
  }
  .right.active{
    pointer-events: auto;
  }
}

  </style>
</head>
<body>
  <div class="app">
    <div id="panelOverlay" class="panel-overlay"></div>

    <!-- Sağ Panel Açma Butonu (mobilde görünür) -->
<button id="rightMenuToggle" class="right-menu-btn" aria-label="Profile panelini aç">☰</button>

    <div id="menuToggle">☰</div>

    <!-- SOL PANEL -->
    <aside class="sidebar">
      <div class="row" style="justify-content:space-between;">
        <h3 class="title">Top 10 Users</h3>
        <div class="row">
          <button id="homeBtn" class="btn ghost" title="Tüm fotoğraflar">🏠</button>
          <button id="refreshBtn" class="btn ghost" title="Yenile">⟳</button>
        </div>
      </div>
      <input id="searchUser" type="text" placeholder="Kullanıcı ara..." style="width:100%; margin-bottom:10px;"/>
      <ul id="searchResults"></ul>
      <ul id="topList"></ul>
      <p class="muted" style="margin-top:10px;">Bir kullanıcıya tıklayın → sadece onun fotoğrafları haritada görünsün. Alt menüden Follow/Unfollow.</p>
    </aside>

    <!-- HARİTA -->
    <main class="mapwrap">
      <!-- Search box -->
      <div class="map-search">
        <input id="mapSearchInput" type="text" placeholder="Adres / yer ara…" />
        <button id="mapSearchBtn" class="btn">Ara</button>
        <div id="mapSearchResults" class="results"></div>
      </div>

      <div id="map"></div>
      <div class="map-footer">
      <div class="row" style="gap:8px;">
      <button id="addPhoto" class="btn primary" style="flex:1;">+ Fotoğraf</button>
      <button id="toggleTimeline" class="btn" style="flex:1;">🕒 Timeline</button>
      </div>
      </div>

      <!-- Timeline alanı (haritanın hemen altında) -->
      <div id="timelineWrap" class="timeline hidden"></div>


      <div id="hint" class="hint">Haritadan konum seçin…</div>

      <div id="overlay" class="overlay"></div>

      <!-- Fotoğraf Yükleme Modalı -->
      <div id="photoForm" class="photo-form">
        <h3>Fotoğraf Ekle</h3>
        <div id="chosenLoc" class="muted">Konum: –</div>
        <div class="row" style="justify-content:space-between; margin-bottom:6px;">
          <button id="pickOnMap" class="btn ghost">Haritadan seç</button>
          <small class="muted">Seçmezsen harita merkezi kullanılır</small>
        </div>
        <input type="file" id="fileInput" accept="image/*" />
        <div id="previewWrap" style="display:none; margin-top:6px;"></div>
        <!-- Çekim tarihi -->
        <div style="margin-top:8px;">
        <label class="muted" for="photoDate">Çekim tarihi</label>
        <input type="date" id="photoDate" />
        </div>

        <div class="row" style="justify-content:flex-end; gap:8px; margin-top:8px;">
          <button id="cancelUpload" class="btn">İptal</button>
          <button id="confirmUpload" class="btn primary">Yükle</button>
        </div>
        <div id="uploadErr" class="error"></div>
      </div>
      <!-- SAĞ PANEL -->
    </main>
    <aside class="right">
      
      <!-- Bildirimler -->
      <div class="notifWrap">
        <div class="row" style="gap:8px; align-items:center;">
          <button id="btnNotif" class="btn ghost">🔔 Bildirimler</button>
          <span id="notifBadge" class="badge" style="display:none;">0</span>
          <button id="btnReadAll" class="btn" title="Tümünü okundu yap">Okundu ✓</button>
        </div>
        <div id="notifDropdown" class="notifDropdown">
          <div class="row" style="justify-content:space-between; align-items:center; padding:8px 12px; border-bottom:1px solid #eee; background:#fafbff;">
            <b>Bildirimler</b>
            <button id="closeNotif" class="btn">Kapat</button>
          </div>
          <div id="notifList"></div>
        </div>
      </div>

      <!-- GİRİŞ -->
      <div id="loginBox">
        <h3 class="title">Giriş Yap</h3>
        <input id="loginEmail" type="email" placeholder="Email"/>
        <input id="loginPass" type="password" placeholder="Şifre"/>
        <div class="row" style="gap:8px;">
          <button id="btnLogin" class="btn primary" style="flex:1;">Giriş</button>
        </div>
        <div class="row" style="gap:8px; margin-top:6px;">
          <button id="showRegister" class="btn" style="flex:1;">Yeni Kullanıcı</button>
        </div>
        <div id="loginErr" class="error"></div>
      </div>

      <!-- KAYIT -->
      <div id="regBox" style="display:none;">
        <h3 class="title">Kayıt Ol</h3>
        <input id="regEmail" type="email" placeholder="Email"/>
        <input id="regPass" type="password" placeholder="Şifre"/>
        <div class="row" style="gap:8px;">
          <button id="btnRegister" class="btn primary" style="flex:1;">Kaydol</button>
          <button id="showLogin" class="btn" style="flex:1;">Girişe Dön</button>
        </div>
        <div id="regErr" class="error"></div>
      </div>

      <!-- KULLANICI -->
      <div id="userBox" style="display:none;">
        <h3 class="title" id="hello">Hoş geldin!</h3>
        <div class="me-header">
        <img id="meAvatar" class="me-avatar" src="" alt="avatar"/></div>
        <div class="kpi">Email: <b id="meEmail">–</b></div>
        <div class="kpi">Coin: <b id="meCoin">0</b></div>
        <div class="kpi">Posts: <b id="mePosts">0</b></div>
        <div class="kpi">Followers: <b id="meFollowers" style="cursor:pointer; color:#2a7aee;">0</b></div>
        <div class="kpi">Following: <b id="meFollowing" style="cursor:pointer; color:#2a7aee;">0</b></div>

        <!-- Profile Settings (butonla aç/kapa) -->
        <div class="row" style="gap:8px; margin-top:8px;">
          <button id="toggleProfileSettings" class="btn">Profile Settings</button>
          <button id="togglePhotoSettings" class="btn">Photo Settings</button>
        </div>

        <div id="profileSettingsSection" class="section hidden">
          <h4 style="margin:0 0 12px 0;">Profil Ayarları</h4>

        <!-- Avatar Alanı -->
       <div class="profile-avatar-wrap">
       <img id="avatarPreview" src="" alt="avatar" class="profile-avatar"/>
       <label class="btn avatar-upload-btn">
      📷 Yeni Avatar
      <input id="editAvatar" type="file" accept="image/*" hidden />
    </label>
  </div>

  <!-- Kullanıcı Adı -->
  <div class="profile-input-wrap">
    <label for="editUsername">Kullanıcı Adı</label>
    <input id="editUsername" type="text" placeholder="Yeni kullanıcı adınız..." />
  </div>

  <!-- Şifre Güncelleme -->
  <div class="profile-input-wrap">
    <label>Şifre Değiştir</label>
    <button id="btnTogglePass" class="btn ghost small-btn">Şifre Güncelle</button>
    <div id="passWrap" class="row" style="gap:8px; margin-top:6px;">
      <input id="newPass" type="password" placeholder="Yeni şifre" disabled />
      <input id="newPass2" type="password" placeholder="Tekrar" disabled />
    </div>
  </div>

  <!-- Kaydet Butonu -->
  <div class="profile-save-wrap">
    <button id="saveEdit" class="btn primary">Değişiklikleri Kaydet</button>
  </div>

  <div id="editErr" class="error"></div>
</div>

        <!-- Photo Settings: sağ panel içinde -->
        <div id="photoSettingsSection" class="section hidden">
          <h4 style="margin:0 0 8px 0;">Fotoğraflarım</h4>
          <div id="psList"></div>
        </div>

        <div class="featureBtns">
          <button class="btn ghost feat" data-key="vrtour">VR Tour</button>
          <button class="btn ghost feat" data-key="challenges">Challenges</button>
          <button class="btn ghost feat" data-key="nft">NFT Collection</button>
          <button class="btn ghost feat" data-key="guide">ChronoGuide</button>
          <button class="btn ghost feat" data-key="nav">Navigation</button>
          <button class="btn ghost feat" data-key="timeline">TimeLine</button>
        </div>

        <div class="row" style="justify-content:flex-end; margin-top:10px;">
          <button id="btnLogout" class="btn">Çıkış</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Supabase Client -->
  <script>
    // Supabase ayarların
    const supabaseUrl = "https://bzewcgcwtdqnorlclcyd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ6ZXdjZ2N3dGRxbm9ybGNsY3lkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTE2ODgsImV4cCI6MjA3MjM4NzY4OH0.s8GnQGeyhoXL-R2acBtdPmI3RAYLxk-CwvyW001hY6w";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });
  </script>

  <!-- App JS -->
  <script>
    // Manifest linkini sadece http/https altında ekle (file:// CORS uyarısını engeller)
    (function(){
      var proto = window.location.protocol;
      if (proto === "http:" || proto === "https:") {
        var l = document.createElement('link');
        l.rel = 'manifest';
        l.href = 'manifest.json';
        document.head.appendChild(l);
      }
    })();

    // Helpers
    function qs(sel){ return document.querySelector(sel); }
    function escapeHtml(str){
      str = str || "";
      return str.replace(/[&<>"']/g, function(m){ return ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" })[m]; });
    }
    async function compressImageIfNeeded(file, maxDim, maxMB){
      try{
        if (!file || !/^image\//.test(file.type)) return file;
        var url = URL.createObjectURL(file);
        var img = await new Promise(function(res, rej){ var im = new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=url; });
        var w = img.width, h = img.height, scale = Math.min(1, maxDim/Math.max(w,h));
        var c = document.createElement('canvas'); c.width = Math.round(w*scale); c.height = Math.round(h*scale);
        var ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
        var q=0.9, blob = await new Promise(r=>c.toBlob(r,'image/jpeg',q));
        while(blob && blob.size>maxMB*1024*1024 && q>0.5){ q-=0.1; blob=await new Promise(r=>c.toBlob(r,'image/jpeg',q)); }
        URL.revokeObjectURL(url);
        if (!blob) return file;
        if (blob.size < file.size) return new File([blob], (file.name.split('.').slice(0,-1).join('.')||'image')+'.jpg', {type:'image/jpeg'});
        return file;
      }catch(e){ return file; }
    }

    // Leaflet Map
    var map = L.map("map", { tapTolerance: 15 }).setView([39, 35], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap" }).addTo(map);

    function thumbIcon(url){
      return L.divIcon({
        className: '',
        html: '<div class="thumb-marker"><img src="'+url+'" alt="" loading="lazy" decoding="async"/></div>',
        iconSize: [42,42], iconAnchor:[21,21], popupAnchor:[0,-18]
      });
    }

    var markers = [];
    function clearMarkers() {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
}
    var markerByPhotoId = {}; // photo.id -> Leaflet marker

    // Refs
    var $ = {
      // left
      topList: qs("#topList"), homeBtn: qs("#homeBtn"), refreshBtn: qs("#refreshBtn"),
      searchUser: qs("#searchUser"), searchResults: qs("#searchResults"),
      // map
      mapSearchInput: qs("#mapSearchInput"), mapSearchBtn: qs("#mapSearchBtn"), mapSearchResults: qs("#mapSearchResults"),
      hint: qs("#hint"), overlay: qs("#overlay"), photoForm: qs("#photoForm"),
      chosenLoc: qs("#chosenLoc"), fileInput: qs("#fileInput"), uploadErr: qs("#uploadErr"),
      cancelUpload: qs("#cancelUpload"), confirmUpload: qs("#confirmUpload"),
      pickOnMap: qs("#pickOnMap"), previewWrap: qs("#previewWrap"),
      // right
      addPhoto: qs("#addPhoto"),
      loginBox: qs("#loginBox"), regBox: qs("#regBox"), userBox: qs("#userBox"),
      loginEmail: qs("#loginEmail"), loginPass: qs("#loginPass"),
      btnLogin: qs("#btnLogin"), showRegister: qs("#showRegister"),
      regEmail: qs("#regEmail"), regPass: qs("#regPass"),
      btnRegister: qs("#btnRegister"), showLogin: qs("#showLogin"),
      loginErr: qs("#loginErr"), regErr: qs("#regErr"),
      meEmail: qs("#meEmail"), meCoin: qs("#meCoin"), mePosts: qs("#mePosts"),
      meFollowers: qs("#meFollowers"), meFollowing: qs("#meFollowing"),
      btnLogout: qs("#btnLogout"),photoDate: qs("#photoDate"),
      toggleTimeline: qs("#toggleTimeline"),
      timelineWrap: qs("#timelineWrap"),

      // profile settings in-panel
      toggleProfileSettings: qs("#toggleProfileSettings"),
      togglePhotoSettings: qs("#togglePhotoSettings"),
      profileSettingsSection: qs("#profileSettingsSection"),
      photoSettingsSection: qs("#photoSettingsSection"),
      editUsername: qs("#editUsername"), editAvatar: qs("#editAvatar"),
      avatarPreview: qs("#avatarPreview"),
      btnTogglePass: qs("#btnTogglePass"), newPass: qs("#newPass"), newPass2: qs("#newPass2"),
      saveEdit: qs("#saveEdit"), editErr: qs("#editErr"),
      psList: qs("#psList"),
      // notifications
      notifDropdown: qs("#notifDropdown"), notifList: qs("#notifList"),
      notifBadge: qs("#notifBadge"), btnNotif: qs("#btnNotif"), btnReadAll: qs("#btnReadAll"), closeNotif: qs("#closeNotif")
    };
    // Avatar dosyası seçilince anlık önizleme (profile + sağ panel header)
if ($.editAvatar) {
  $.editAvatar.addEventListener('change', function(){
    var f = this.files && this.files[0];
    if (!f) return;
    var temp = URL.createObjectURL(f);
    if ($.avatarPreview) $.avatarPreview.src = temp;
    var meImg = document.getElementById('meAvatar');
    if (meImg) meImg.src = temp;
  });
}


    function setModal(open){ $.overlay.classList.toggle("active", open); $.photoForm.classList.toggle("active", open); }

    // Auth / session
    var notifChannel = null;
    async function getSessionUser(){
      var s = await supabase.auth.getSession();
      return s && s.data && s.data.session ? s.data.session.user : null;
    }

    async function getAvatarUrl(userId){
      // 1) profile.avatar_url → 2) first photo → 3) placeholder
      var pr = await supabase.from("user_profiles").select("avatar_url").eq("id", userId).single();
      if (pr && pr.data && pr.data.avatar_url) return pr.data.avatar_url;
      var fp = await supabase.from("photos").select("image_url").eq("user_id", userId).order("id", {ascending:true}).limit(1);
      if (fp && fp.data && fp.data.length) return fp.data[0].image_url;
      // tiny svg placeholder
      return "data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#e5e7eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="14">?</text></svg>');
    }

    async function refreshAvatarPreview(userId){
  var url = await getAvatarUrl(userId) || "";
  // cache-bust: upsert edilen aynı URL'yi tarayıcıdan taze çekmek için
  var bust = url ? (url + (url.includes('?') ? '&' : '?') + 't=' + Date.now()) : "";

  if ($.avatarPreview) $.avatarPreview.src = bust || "";
  var meImg = document.getElementById('meAvatar');
  if (meImg) meImg.src = bust || "";
}
    async function renderTimeline(){
  // Fotoğrafları tarihe göre çek
  const r = await supabase
    .from('photos')
    .select('id,image_url,lat,lng,taken_on')
    .order('taken_on', { ascending: true })
    .order('id', { ascending: true })
    .limit(1000);

  const ph = r?.data || [];
  if (!ph.length){
    $.timelineWrap.innerHTML = '<div class="muted">Henüz fotoğraf yok.</div>';
    return;
  }

  // Günlere göre grupla
  const byDay = {};
  for (const p of ph){
    const key = p.taken_on || new Date().toISOString().slice(0,10);
    (byDay[key] ||= []).push(p);
  }

  // HTML üret
  let html = '';
  const days = Object.keys(byDay).sort(); // eskiden yeniye
  for (const d of days){
    html += `<div class="tl-day">
      <div class="tl-date">${d}</div>
      <div class="tl-strip">` +
      byDay[d].map(p => `<img class="tl-thumb" data-id="${p.id}" src="${p.image_url}" loading="lazy" decoding="async">`).join('') +
      `</div>
    </div>`;
  }
  $.timelineWrap.innerHTML = html;

  // Tıklayınca haritaya odaklan + popup aç
  $.timelineWrap.querySelectorAll('.tl-thumb').forEach(img => {
    img.onclick = async () => {
      const pid = parseInt(img.getAttribute('data-id'), 10);
      // marker varsa doğrudan popup
      const mk = markerByPhotoId[pid];
      if (mk) {
        map.setView(mk.getLatLng(), 13);
        mk.openPopup();
      } else {
        // marker henüz yoksa DB'den çek ve haritayı taşı
        const rp = await supabase.from('photos').select('*').eq('id', pid).single();
        const p = rp?.data;
        if (p){
          currentFilterUserId = null;
          await loadPhotos(null);
          const mk2 = markerByPhotoId[pid];
          if (mk2){
            map.setView([p.lat,p.lng], 13);
            mk2.openPopup();
          }
        }
      }
    };
  });
}


    async function updateUserPanel(userId){
      var profileRes = await supabase.from("user_profiles").select("*").eq("id", userId).single();
      var profile = profileRes ? profileRes.data : null;
      if (profile){
        $.meCoin.textContent = (profile.coin || 0);
        $.mePosts.textContent = (profile.posts || 0);
      }
      var f1 = await supabase.from("follows").select("*",{count:"exact",head:true}).eq("following", userId);
      $.meFollowers.textContent = f1 && typeof f1.count === 'number' ? f1.count : 0;
      var f2 = await supabase.from("follows").select("*",{count:"exact",head:true}).eq("follower", userId);
      $.meFollowing.textContent = f2 && typeof f2.count === 'number' ? f2.count : 0;
    }

    async function refreshUI(){
      var user = await getSessionUser();
      if (!user){
        $.loginBox.style.display = "block";
        $.regBox.style.display = "none";
        $.userBox.style.display = "none";
        $.notifList.innerHTML = ""; $.notifBadge.style.display = "none";
        $.notifDropdown.classList.remove('active');
        if (notifChannel) { try{ supabase.removeChannel(notifChannel); }catch(e){} notifChannel = null; }
        await loadPhotos(null); await loadTopUsers();
        return;
      }
      $.loginBox.style.display = "none";
      $.regBox.style.display = "none";
      $.userBox.style.display = "block";
      $.meEmail.textContent = user.email;
      await updateUserPanel(user.id);
      await loadPhotos(currentFilterUserId);
      await loadTopUsers();
      await loadNotifications(user.id);
       if (typeof subscribeNotifications === 'function') {
        subscribeNotifications(user.id);
}
      await refreshAvatarPreview(user.id);
    }
    supabase.auth.onAuthStateChange(function(){ refreshUI(); });

    // Notifications
    function typeLabel(t){
  return t === 'like' ? '❤️ Beğeni'
       : t === 'comment' ? '💬 Yorum'
       : '➕ Takip';
}

    // "x dakika önce" biçimi
    function timeAgo(iso){
    try {
    const now = Date.now();
    const then = new Date(iso).getTime();
    const diff = Math.max(0, now - then);
    const sec = Math.floor(diff / 1000);
    if (sec < 60) return `${sec}s önce`;
    const min = Math.floor(sec / 60);
    if (min < 60) return `${min}dk önce`;
    const hr = Math.floor(min / 60);
    if (hr < 24) return `${hr}s önce`;
    const day = Math.floor(hr / 24);
    if (day < 7) return `${day}g önce`;
    // daha eskiyse tarih/saat göster
    return new Date(iso).toLocaleString();
  } catch(e){ return ""; }
}

// Tarihi "Bugün", "Dün" veya YYYY-MM-DD olarak gruplamak
function groupDateLabel(iso){
  const d = new Date(iso);
  const today = new Date(); today.setHours(0,0,0,0);
  const that = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diffDays = Math.round((today - that) / 86400000);
  if (diffDays === 0) return "Bugün";
  if (diffDays === 1) return "Dün";
  return d.toLocaleDateString();
}

async function loadNotifications(userId){
  const res = await supabase
    .from("notifications")
    .select("id,type,message,is_read,created_at,photo_id,comment_id,actor")
    .eq("recipient", userId)
    .order("created_at", { ascending:false })
    .limit(80);

  if (!res || res.error) return;

  const data = res.data || [];

  // Aktör isimlerini topla
  const actorIds = [];
  for (const n of data){ if (n.actor && !actorIds.includes(n.actor)) actorIds.push(n.actor); }
  const nameMap = {};
  if (actorIds.length){
    const p = await supabase.from('user_profiles').select('id,username').in('id', actorIds);
    const arr = p?.data || [];
    for (const it of arr){ nameMap[it.id] = it.username; }
  }
  function subscribeNotifications(userId){
  // Eski kanalı temizle
  try {
    if (notifChannel) supabase.removeChannel(notifChannel);
  } catch (e) { /* yoksay */ }

  // Yeni kanal: sadece bu kullanıcıya gelen yeni bildirim INSERT'lerinde tetiklensin
  notifChannel = supabase
    .channel('notif:' + userId)
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications',
      filter: 'recipient=eq.' + userId
    }, async () => {
      await loadNotifications(userId);
    })
    .subscribe();
}

  // okunmamış sayısı
  let unread = 0;
  for (const n of data){ if (!n.is_read) unread++; }
  $.notifBadge.textContent = String(unread);
  $.notifBadge.style.display = unread > 0 ? "inline-flex" : "none";

  if (!data.length){
    $.notifList.innerHTML = '<div class="muted" style="padding:12px;">Henüz bildirim yok.</div>';
    return;
  }

  // Tarihe göre grupla
  const groups = {};
  for (const n of data){
    const key = groupDateLabel(n.created_at);
    if (!groups[key]) groups[key] = [];
    groups[key].push(n);
  }

  // HTML üret
  let html = '';
  for (const gKey of Object.keys(groups)){
    html += `<div class="notifGroupDate">${gKey}</div>`;
    for (const n of groups[gKey]){
      const actorName = nameMap[n.actor] ? `<b>${escapeHtml(nameMap[n.actor])}</b> ` : '';
      const msg = n.type === 'like'
        ? `${actorName}fotoğrafını beğendi.`
        : n.type === 'comment'
          ? `${actorName}yorum yaptı.`
          : `${actorName}seni takip etti.`;

      html += `
        <div class="notifItem ${n.is_read ? '' : 'unread'}" data-id="${n.id}">
          <div class="notifMain">
            <span class="notifType">${typeLabel(n.type)}</span>
            <div class="notifMsg">${msg}</div>
          </div>
          <div class="notifActions">
            ${n.photo_id ? `<button class="btn ghost goPhoto" data-id="${n.photo_id}">Fotoğrafa git</button>` : ''}
            ${!n.is_read ? `<button class="btn markRead" data-id="${n.id}">Okundu</button>` : ''}
            <div class="notifTime">${timeAgo(n.created_at)}</div>
          </div>
        </div>
      `;
    }
  }
  $.notifList.innerHTML = html;

  // Aksiyon bağları
  $.notifList.querySelectorAll(".goPhoto").forEach(btn => {
    btn.onclick = async (e) => {
      const pid = parseInt(btn.dataset.id, 10);
      const rp = await supabase.from("photos").select("*").eq("id", pid).single();
      const p = rp?.data;
      if (p){
        currentFilterUserId = null;
        await loadPhotos(null);
        map.setView([p.lat, p.lng], 12);
        $.notifDropdown.classList.remove('active');
      }
    };
  });

  $.notifList.querySelectorAll(".markRead").forEach(btn => {
    btn.onclick = async (e) => {
      const id = parseInt(btn.dataset.id, 10);
      await supabase.from("notifications").update({ is_read: true }).eq("id", id);
      await loadNotifications(userId);
    };
  });
}
function subscribeNotifications(userId){
  try { if (notifChannel) supabase.removeChannel(notifChannel); } catch(e){}
  notifChannel = supabase
    .channel('notif:' + userId)
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications',
      filter: 'recipient=eq.' + userId
    }, async () => {
      await loadNotifications(userId);
    })
    .subscribe();
}

    $.btnReadAll.onclick = async function(){ var me = await getSessionUser(); if (!me) return; await supabase.from("notifications").update({ is_read: true }).eq("recipient", me.id).eq("is_read", false); await loadNotifications(me.id); };
    $.btnNotif.onclick = async function(){ var me = await getSessionUser(); if (!me) return; $.notifDropdown.classList.toggle('active'); if ($.notifDropdown.classList.contains('active')) await loadNotifications(me.id); };
    $.closeNotif.onclick = function(){ $.notifDropdown.classList.remove('active'); };
   
    // Dışarı tıklayınca dropdown'ı kapat
  document.addEventListener('click', function(e){
    const dd = $.notifDropdown;
    if (!dd) return;
    const inDropdown = e.target.closest('.notifDropdown');
    const inButton = e.target.closest('#btnNotif');
    if (!inDropdown && !inButton) dd.classList.remove('active');
  });

    // Photos
    var currentFilterUserId = null;
    var pendingLatLng = null;
    var editingPhoto = null;
    var pendingEditLatLng = null;

async function buildPopup(photo) {
  const me = await getSessionUser();
  const { count: likeCount } = await supabase
    .from("likes")
    .select("*", { count: "exact", head: true })
    .eq("photo_id", photo.id);

  let liked = false;
  if (me) {
    const { data: myLike } = await supabase
      .from("likes")
      .select("id")
      .eq("photo_id", photo.id)
      .eq("user_id", me.id)
      .limit(1);
    liked = (myLike ?? []).length > 0;
  }

  const { data: comments } = await supabase
    .from("comments")
    .select("content,created_at,user_id")
    .eq("photo_id", photo.id)
    .order("created_at", { ascending: false })
    .limit(50);

  const wrap = document.createElement("div");
  wrap.className = "popup";
  wrap.innerHTML =
    '<img src="' + photo.image_url + '" alt="photo" loading="lazy" decoding="async"/>' +
    '<div class="row" style="align-items:center;">' +
    '<div>' +
    '<span class="like" title="beğen">' + (liked ? "❤️" : "🤍") + '</span> ' +
    '<span><b>' + likeCount + '</b> likes</span>' +
    '</div>' +
    ((me && me.id === photo.user_id)
      ? (
        '<div class="dropdown" style="margin-left:auto;">' +
        '<span class="menu-trigger">⋯</span>' +
        '<div class="dropdown-menu">' +
        '<button class="btnEditPhoto">📍 Konumu/etiketi düzenle</button>' +
        '</div></div>'
      ) : '') +
    '</div>' +
    '<div class="comments">' +
    (comments ?? []).map(function (c) {
      return '<div>• <b>' + escapeHtml(c.user_id) + '</b>: ' +
        escapeHtml(c.content) +
        '</div>';
    }).join("") +
    '</div>' +
    '<input type="text" class="commentInput" placeholder="Yorum yaz ve Enter"/>';

  // Dropdown Menü Aç/Kapat
  const trig = wrap.querySelector('.menu-trigger');
  if (trig) {
    const menu = wrap.querySelector('.dropdown-menu');
    trig.onclick = function (e) {
      e.stopPropagation();
      menu.classList.toggle('active');
    };
  }

  // ❤️ Beğeni
  const likeBtn = wrap.querySelector(".like");
  likeBtn.onclick = async function () {
    const user = await getSessionUser();
    if (!user) { alert("Önce giriş yapınız."); return; }
    if (liked) {
      await supabase.from("likes").delete().eq("photo_id", photo.id).eq("user_id", user.id);
    } else {
      await supabase.from("likes").insert({ photo_id: photo.id, user_id: user.id });
      const owner = await supabase.from('user_profiles').select('coin').eq('id', photo.user_id).single();
      if (owner && owner.data)
        await supabase.from('user_profiles').update({ coin: (owner.data.coin || 0) + 5 }).eq('id', photo.user_id);
    }
    await loadPhotos(currentFilterUserId);
  };

  // 💬 Yorum ekleme
  const ci = wrap.querySelector(".commentInput");
  ci.addEventListener("keypress", async function (e) {
    if (e.key === "Enter") {
      const user = await getSessionUser();
      if (!user) { alert("Önce giriş yapınız."); return; }
      const content = ci.value.trim();
      if (!content) return;
      await supabase.from("comments").insert({ photo_id: photo.id, user_id: user.id, content: content });
      ci.value = "";
      await loadPhotos(currentFilterUserId);
    }
  });

  // 📍 Konumu Değiştir
  const btnEditPhoto = wrap.querySelector('.btnEditPhoto');
if (btnEditPhoto) {
  btnEditPhoto.onclick = function () {
    alert("Yeni konumu haritadan seçin");

    // Bir defaya mahsus tıklama dinleyicisi
    map.once("click", async function (e) {
      const newLat = e.latlng.lat;
      const newLng = e.latlng.lng;

      try {
        // Supabase güncelleme
        const { error } = await supabase
          .from("photos")
          .update({ lat: newLat, lng: newLng })
          .eq("id", photo.id);

        if (error) {
          alert("Konum güncellenemedi: " + error.message);
          return;
        }

        // Popup'u kapat
        map.closePopup();

        // Fotoğrafları yeniden yükle ve marker'ı güncelle
        await loadPhotos(currentFilterUserId);

        // Haritayı yeni konuma odakla
        map.setView([newLat, newLng], 14);

        alert("Konum başarıyla güncellendi!");
      } catch (err) {
        alert("Beklenmeyen hata: " + err.message);
      }
    });
  };
}

  return wrap;
}

    async function loadPhotos(filterUserId){
      clearMarkers();
      var q = supabase.from("photos").select("*").order("id", { ascending: false }).limit(500);
      if (filterUserId) q = q.eq("user_id", filterUserId);
      var r = await q;
      var photos = r && r.data ? r.data : [];
      for (var i=0;i<photos.length;i++){
        var p = photos[i];
        var popup = await buildPopup(p);
        var m = L.marker([p.lat, p.lng], { icon: thumbIcon(p.image_url) }).addTo(map).bindPopup(popup);
        markers.push(m);
        markerByPhotoId[p.id] = m; 

      }
    }

    // Top Users + avatars
    // Top Users - modern cards with inline follow & quick view
async function loadTopUsers(){
  // skeleton göster
  $.topList.innerHTML = '<div class="user-skel"></div><div class="user-skel"></div><div class="user-skel"></div>';

  // kullanıcıları çek
  const r = await supabase.from("user_profiles").select("id,username,coin,posts,avatar_url");
  const users = r?.data || [];

  // giriş yapan
  const me = await getSessionUser();

  // skoru göre sırala, top 10
  users.sort((a,b)=> (b.coin||0) - (a.coin||0));
  const top = users.slice(0,10);

  // avatarları tamamla (gerekirse ilk foto)
  const withAvatars = await Promise.all(top.map(async (u)=>{
    let av = u.avatar_url;
    if (!av){
      const fp = await supabase.from("photos").select("image_url").eq("user_id", u.id).order("id", {ascending:true}).limit(1);
      if (fp?.data?.length) av = fp.data[0].image_url;
    }
    if (!av){
      av = "data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#e5e7eb"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9ca3af" font-size="14">?</text></svg>');
    }
    return { ...u, avatar_url: av };
  }));

  // follower sayıları (batched)
  const ids = withAvatars.map(u=>u.id);
  let followerCounts = {};
  if (ids.length){
    const fl = await supabase.from("follows").select("following").in("following", ids);
    // reduce
    (fl?.data || []).forEach(row=>{
      const k = row.following;
      followerCounts[k] = (followerCounts[k] || 0) + 1;
    });
  }

  // takip durumları (me varsa)
  let myFollowingSet = new Set();
  if (me) {
    const mf = await supabase.from("follows").select("following").eq("follower", me.id);
    (mf?.data || []).forEach(x=> myFollowingSet.add(x.following));
  }

  // HTML kur
  let html = '';
  for (const u of withAvatars){
    const fCount = followerCounts[u.id] || 0;
    const amIFollowing = me ? myFollowingSet.has(u.id) : false;

    html += `
  <li>
    <div class="user-card" data-uid="${u.id}">
      <img class="user-avatar" src="${u.avatar_url}" alt="">
      <div class="user-meta">
        <div class="user-name">${escapeHtml(u.username || '—')}</div>
        <div class="user-stats">
          <span class="user-stat">💰 ${u.coin || 0}</span>
          <span class="user-stat">🖼️ ${u.posts || 0}</span>
          <span class="user-stat">👥 ${fCount}</span>
        </div>
      </div>
      <div class="user-actions">
        <button class="btn ghost view" data-uid="${u.id}">👁 Göster</button>
        <button class="btn ${amIFollowing ? 'following' : 'follow'} followBtn" data-uid="${u.id}">
          ${amIFollowing ? 'Following' : 'Follow'}
        </button>
      </div>
    </div>
  </li>
`;

  }
  $.topList.innerHTML = html;

  // Göster (sadece bu kullanıcının fotoğraflarını haritada göster)
  $.topList.querySelectorAll('.view').forEach(btn=>{
    btn.onclick = async () => {
      const uid = btn.getAttribute('data-uid');
      currentFilterUserId = uid;
      await loadPhotos(currentFilterUserId);
    };
  });

  // Follow / Unfollow
  $.topList.querySelectorAll('.followBtn').forEach(btn=>{
    btn.onclick = async () => {
      const uid = btn.getAttribute('data-uid');
      const meNow = await getSessionUser();
      if (!meNow){ alert('Follow için giriş yapınız.'); return; }

      const isFollowing = btn.textContent.trim() === 'Following';

      if (!isFollowing){
        // follow
        const ins = await supabase.from('follows').insert({ follower: meNow.id, following: uid });
        if (!ins?.error){
          // coin ödülü: takip edilen kullanıcıya +10 (opsiyon: aynı mantık korunuyor)
          const prof = await supabase.from('user_profiles').select('coin').eq('id', uid).single();
          if (prof?.data){
            await supabase.from('user_profiles').update({ coin: (prof.data.coin||0) + 10 }).eq('id', uid);
          }
          // UI güncelle
          btn.textContent = 'Following';
          btn.classList.remove('follow'); btn.classList.add('following');
          // followers sayısını arayüzde arttır
          const card = btn.closest('.user-card');
          const stat = card?.querySelector('.user-stats .user-stat:nth-child(3)');
          if (stat){
            const parts = stat.textContent.trim().split(' ');
            const num = parseInt(parts[1] || parts[0] || '0', 10);
            stat.textContent = `👥 ${isNaN(num) ? 1 : num + 1}`;
          }
          await updateUserPanel(meNow.id);
        }
      } else {
        // unfollow
        const del = await supabase.from('follows').delete().eq('follower', meNow.id).eq('following', uid);
        if (!del?.error){
          btn.textContent = 'Follow';
          btn.classList.remove('following'); btn.classList.add('follow');
          const card = btn.closest('.user-card');
          const stat = card?.querySelector('.user-stats .user-stat:nth-child(3)');
          if (stat){
            const parts = stat.textContent.trim().split(' ');
            const num = parseInt(parts[1] || parts[0] || '0', 10);
            stat.textContent = `👥 ${Math.max(0, isNaN(num) ? 0 : num - 1)}`;
          }
          await updateUserPanel(meNow.id);
        }
      }
    };
  });
}


    // Sol panel kullanıcı arama
    $.searchUser.addEventListener("input", async function(e){
      var term = e.target.value.trim();
      if (!term) { $.searchResults.innerHTML = ""; return; }
      var r = await supabase.from("user_profiles").select("id, username, posts, avatar_url").ilike("username", "%"+term+"%").limit(12);
      var users = r && r.data ? r.data : [];
      var html = '';
      for (var i=0;i<users.length;i++){
        var u = users[i], av = u.avatar_url;
        if (!av){
          var fp = await supabase.from("photos").select("image_url").eq("user_id", u.id).order("id", {ascending:true}).limit(1);
          if (fp && fp.data && fp.data.length) av = fp.data[0].image_url;
        }
        if (!av) av = "data:image/svg+xml;utf8,"+encodeURIComponent('<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"64\" height=\"64\"><rect width=\"100%\" height=\"100%\" fill=\"#e5e7eb\"/><text x=\"50%\" y=\"50%\" dominant-baseline=\"middle\" text-anchor=\"middle\" fill=\"#9ca3af\" font-size=\"14\">?</text></svg>');
        html += '<li class="user-item" data-id="'+u.id+'"><div class="user-line"><img class="avatar-sm" src="'+av+'"><b>'+escapeHtml(u.username)+'</b> <span class="muted">• '+(u.posts||0)+' post</span></div></li>';
      }
      $.searchResults.innerHTML = html;
      var items = $.searchResults.querySelectorAll(".user-item");
      for (var k=0;k<items.length;k++){
        items[k].onclick = async function(){ currentFilterUserId = this.dataset.id; await loadPhotos(currentFilterUserId); };
      }
    });
    // Add Photo (modal)
    $.addPhoto.onclick = async function(){
      var user = await getSessionUser(); if (!user) { alert("Önce giriş yapınız."); return; }
      pendingLatLng = map.getCenter();
      $.chosenLoc.textContent = "Konum: "+pendingLatLng.lat.toFixed(5)+", "+pendingLatLng.lng.toFixed(5);
      $.uploadErr.textContent = ""; $.fileInput.value = ""; $.previewWrap.innerHTML = ""; $.previewWrap.style.display = "none";
      setModal(true);
      if ($.photoDate) {
      $.photoDate.value = new Date().toISOString().slice(0,10); // YYYY-MM-DD
      }

    };
    $.pickOnMap.onclick = function(){
      $.photoForm.classList.remove('active'); $.overlay.classList.remove('active'); $.hint.classList.add("active");
      var onClick = function(e){ pendingLatLng = e.latlng; $.chosenLoc.textContent = "Konum: "+pendingLatLng.lat.toFixed(5)+", "+pendingLatLng.lng.toFixed(5); $.hint.classList.remove("active"); map.off("click", onClick); setModal(true); };
      map.once("click", onClick);
    };
    $.fileInput.onchange = function(){ var f = $.fileInput.files && $.fileInput.files[0]; if (f){ $.previewWrap.style.display="block"; $.previewWrap.innerHTML='<img src="'+URL.createObjectURL(f)+'" style="width:100%;border-radius:12px;margin-top:6px;" loading="lazy" decoding="async">'; } };
    $.cancelUpload.onclick = function(){ setModal(false); pendingLatLng = null; };
    $.confirmUpload.onclick = async function(){
      try{
        $.uploadErr.textContent = "";
        var user = await getSessionUser(); if (!user) { alert("Önce giriş yapınız."); return; }
        if (!pendingLatLng) { pendingLatLng = map.getCenter(); }
        var f = $.fileInput.files && $.fileInput.files[0]; if (!f){ $.uploadErr.textContent="Lütfen fotoğraf seçin."; return; }
        f = await compressImageIfNeeded(f, 1920, 2);
        var ext = (f.name.split(".").pop() || "jpg"); var path = user.id + "/" + Date.now() + "." + ext;
        var up = await supabase.storage.from("photos").upload(path, f); if (up && up.error){ $.uploadErr.textContent="Yükleme hatası: "+up.error.message; return; }
        var pub = supabase.storage.from("photos").getPublicUrl(path); var imageUrl = pub && pub.data ? pub.data.publicUrl : null; if (!imageUrl){ $.uploadErr.textContent="Public URL oluşturulamadı."; return; }
        var takenOn = ($.photoDate && $.photoDate.value) ? $.photoDate.value : new Date().toISOString().slice(0,10);
        var ins = await supabase.from("photos").insert({
        user_id: user.id,
        lat: pendingLatLng.lat,
        lng: pendingLatLng.lng,
        image_url: imageUrl,
        taken_on: takenOn
        });
        var pr = await supabase.from("user_profiles").select("coin,posts,avatar_url").eq("id", user.id).single();
        if (pr && pr.data){ if (!pr.data.avatar_url){ await supabase.from('user_profiles').update({ avatar_url: imageUrl }).eq('id', user.id); } await supabase.from("user_profiles").update({ coin: (pr.data.coin||0)+10, posts: (pr.data.posts||0)+1 }).eq("id", user.id); }
        setModal(false); pendingLatLng=null; await updateUserPanel(user.id); await loadPhotos(currentFilterUserId); await refreshAvatarPreview(user.id); alert("Fotoğraf yüklendi!");
      }catch(e){ $.uploadErr.textContent="Beklenmeyen hata: "+(e&&e.message?e.message:e); }
    };
    // =========================
// Fotoğraf Konumunu Güncelleme
// =========================
async function updatePhotoLocation(photoId, newLat, newLng) {
  try {
    const { error } = await supabase
      .from("photos")
      .update({ lat: newLat, lng: newLng })
      .eq("id", photoId);

    if (error) {
      alert("Konum güncellenemedi: " + error.message);
      return;
    }

    // Haritayı güncelle
    await loadPhotos(currentFilterUserId);
    alert("Konum başarıyla değiştirildi!");
  } catch (e) {
    console.error(e);
    alert("Beklenmeyen hata oluştu!");
  }
}


    // Sağ panel: Profile Settings toggle
    $.toggleProfileSettings.onclick = function(){ $.profileSettingsSection.classList.toggle('hidden'); };
    $.togglePhotoSettings.onclick   = async function(){
      $.photoSettingsSection.classList.toggle('hidden');
      if (!$.photoSettingsSection.classList.contains('hidden')) { await renderPhotoSettings(); }
    };

    // Profile save
    $.btnTogglePass.onclick = function(){ var d=$.newPass.disabled; $.newPass.disabled=!d; $.newPass2.disabled=!d; if(!d){ $.newPass.value=''; $.newPass2.value=''; } };
    $.saveEdit.onclick = async function(){
      $.editErr.textContent = "";
      var me = await getSessionUser(); if (!me) { $.editErr.textContent="Önce giriş yapın."; return; }
      var newName = $.editUsername.value.trim();
      var avatarFile = $.editAvatar.files && $.editAvatar.files[0];
      var np1 = $.newPass.value.trim(), np2 = $.newPass2.value.trim();
      if (np1 || np2){ if (np1.length<8){ $.editErr.textContent='Şifre en az 8 karakter olmalı.'; return; } if (np1!==np2){ $.editErr.textContent='Şifreler eşleşmiyor.'; return; } var pu=await supabase.auth.updateUser({password:np1}); if(pu&&pu.error){ $.editErr.textContent=pu.error.message; return; } }
      var updates = {}; if (newName) updates.username = newName;
      if (avatarFile){ var f = await compressImageIfNeeded(avatarFile, 1024, 1.5); var ext=f.name.split('.').pop()||'jpg'; var avatarPath='avatars/'+me.id+'.'+ext; var up=await supabase.storage.from('avatars').upload(avatarPath,f,{upsert:true}); if(!up||!up.error){ var pub=supabase.storage.from('avatars').getPublicUrl(avatarPath); var url=pub&&pub.data?pub.data.publicUrl:null; if(url) updates.avatar_url=url; } }
      var upUser = await supabase.from('user_profiles').update(updates).eq('id', me.id); if (upUser && upUser.error){ if (upUser.error.message && upUser.error.message.toLowerCase().indexOf('avatar_url')>-1){ delete updates.avatar_url; var up2 = await supabase.from('user_profiles').update(updates).eq('id', me.id); if(up2&&up2.error){ $.editErr.textContent=up2.error.message; return; } } else { $.editErr.textContent=upUser.error.message; return; } }
      await refreshUI(); alert('Profil güncellendi.');
    };

    // Photo Settings (right panel içi)
  async function renderPhotoSettings() {
  const me = await getSessionUser();
  if (!me) {
    $.psList.innerHTML = '<div class="muted">Oturum gerekli.</div>';
    return;
  }

  const r = await supabase
    .from('photos')
    .select('id,image_url,lat,lng,taken_on')
    .eq('user_id', me.id)
    .order('id', { ascending: false });

  const ph = r?.data || [];
  if (!ph.length) {
    $.psList.innerHTML = '<div class="muted">Henüz fotoğraf yok.</div>';
    return;
  }

  let html = '';
  for (const p of ph) {
    html += `
      <div class="photo-card">
        <img src="${p.image_url}" class="photo-thumb" loading="lazy" decoding="async" />
        <div class="photo-info">
          <div><b>ID:</b> ${p.id}</div>
          <div class="muted">📍 ${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div>
          <div class="ps-date-row">
          <label class="muted">Tarih:</label>
          <input type="date" class="ps-date" data-id="${p.id}" value="${(p.taken_on || new Date().toISOString().slice(0,10))}">
          <button class="btn" data-ps-dsave="${p.id}">Kaydet</button>
          </div>
          <div class="photo-actions">
            <button class="btn ghost" data-ps-go="${p.id}">👁 Göster</button>
            <button class="btn edit-btn" data-ps-pick="${p.id}">📍 Konumu Güncelle</button>
            <button class="btn del-btn" data-ps-del="${p.id}">🗑 Sil</button>
          </div>
        </div>
      </div>
    `;
  }

  $.psList.innerHTML = html;

  // Göster
  $.psList.querySelectorAll('[data-ps-go]').forEach(b => {
    b.onclick = async function() {
      const id = parseInt(b.dataset.psGo, 10);
      const { data } = await supabase.from('photos').select('*').eq('id', id).single();
      if (data) {
        currentFilterUserId = null;
        await loadPhotos(null);
        map.setView([data.lat, data.lng], 13);
      }
    };
  });

  // Konum Güncelle
  $.psList.querySelectorAll('[data-ps-pick]').forEach(b => {
    b.onclick = async function() {
      const id = parseInt(b.dataset.psPick, 10);
      const { data: p } = await supabase.from('photos').select('*').eq('id', id).single();
      if (!p) return;

      $.hint.classList.add("active");
      const onClick = async function(e) {
        $.hint.classList.remove("active");
        map.off("click", onClick);

        const updates = { lat: e.latlng.lat, lng: e.latlng.lng };
        const { error } = await supabase.from('photos').update(updates).eq('id', id);

        if (!error) {
          await loadPhotos(currentFilterUserId);
          await renderPhotoSettings();
          map.setView([updates.lat, updates.lng], 14);
        } else {
          alert("Konum güncellenemedi: " + error.message);
        }
      };
      map.once("click", onClick);
    };
  });

  // Sil
  $.psList.querySelectorAll('[data-ps-del]').forEach(b => {
    b.onclick = async function() {
      const id = parseInt(b.dataset.psDel, 10);
      if (!confirm('Fotoğraf silinsin mi?')) return;

      const { error } = await supabase.from('photos').delete().eq('id', id);
      if (error) {
        alert("Silme hatası: " + error.message);
        return;
      }

      const me2 = await getSessionUser();
      const prof = await supabase.from('user_profiles').select('posts').eq('id', me2.id).single();
      if (prof?.data) {
        await supabase
          .from('user_profiles')
          .update({ posts: Math.max(0, (prof.data.posts || 0) - 1) })
          .eq('id', me2.id);
      }

      await loadPhotos(currentFilterUserId);
      await renderPhotoSettings();
    };
  });
  // Tarih kaydet
$.psList.querySelectorAll('[data-ps-dsave]').forEach(function(btn){
  btn.onclick = async function(){
    var id = parseInt(btn.getAttribute('data-ps-dsave'), 10);
    var input = $.psList.querySelector('.ps-date[data-id="'+id+'"]');
    var val = (input && input.value) ? input.value : new Date().toISOString().slice(0,10);

    var up = await supabase.from('photos').update({ taken_on: val }).eq('id', id);
    if (up && up.error) {
      alert('Tarih güncellenemedi: ' + up.error.message);
      return;
    }

    // Listeyi ve açıksa timeline’ı tazele
    await renderPhotoSettings();
    if ($.timelineWrap && !$.timelineWrap.classList.contains('hidden')) {
      await renderTimeline();
    }
  };
});

}

    // Auth (login/register/logout)
    $.showRegister.onclick = function(){ $.loginBox.style.display="none"; $.regBox.style.display="block"; };
    $.showLogin.onclick = function(){ $.regBox.style.display="none"; $.loginBox.style.display="block"; };
    $.btnRegister.onclick = async function(){
      $.regErr.textContent=""; var email=$.regEmail.value.trim(), pass=$.regPass.value.trim(); if(!email||!pass){ $.regErr.textContent="Email ve şifre gerekli."; return; }
      var r = await supabase.auth.signUp({ email:email, password:pass, options:{ email_confirm:false } }); if(r&&r.error){ $.regErr.textContent=r.error.message; return; }
      var user = r&&r.data?r.data.user:null; if(user){ var i=await supabase.from("user_profiles").insert({ id:user.id, username:email, coin:0, posts:0 }); if(i&&i.error) console.warn(i.error.message); }
      alert("Kayıt başarılı! Şimdi giriş yapın."); $.regBox.style.display="none"; $.loginBox.style.display="block";
    };
    $.btnLogin.onclick = async function(){
      $.loginErr.textContent=""; var email=$.loginEmail.value.trim(), pass=$.loginPass.value.trim();
      var r = await supabase.auth.signInWithPassword({ email:email, password:pass }); if(r&&r.error){ $.loginErr.textContent=r.error.message; return; }
      var user = r&&r.data?r.data.user:null; if(user){ var p=await supabase.from("user_profiles").select("id").eq("id",user.id).single(); if(!p||p.error){ await supabase.from("user_profiles").insert({ id:user.id, username:email, coin:0, posts:0 }); } }
      await refreshUI();
    };
    $.btnLogout.onclick = async function(){ await supabase.auth.signOut(); await refreshUI(); };

    // Map search (Nominatim)
    async function nominatimSearch(q){
      var url = "https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(q)+"&limit=8";
      var res = await fetch(url, { headers: { "Accept":"application/json" } });
      if (!res.ok) return [];
      return await res.json();
    }
    $.mapSearchBtn.onclick = async function(){
      var q = $.mapSearchInput.value.trim(); if (!q) return;
      var data = await nominatimSearch(q);
      if (!data || !data.length){ $.mapSearchResults.innerHTML='<div>Sonuç bulunamadı</div>'; $.mapSearchResults.classList.add('active'); return; }
      $.mapSearchResults.innerHTML = data.map(function(it){ return '<div data-lat="'+it.lat+'" data-lon="'+it.lon+'">'+escapeHtml(it.display_name)+'</div>'; }).join('');
      $.mapSearchResults.classList.add('active');
      $.mapSearchResults.querySelectorAll('div').forEach(function(el){
        el.onclick = function(){
          var lat=parseFloat(el.getAttribute('data-lat')), lon=parseFloat(el.getAttribute('data-lon'));
          $.mapSearchResults.classList.remove('active');
          map.setView([lat,lon], 14);
          L.marker([lat,lon]).addTo(map);
        };
      });
    };
    $.mapSearchInput.addEventListener('keydown', function(e){ if (e.key==='Enter'){ $.mapSearchBtn.click(); } });
    document.addEventListener('click', function(e){ if (!e.target.closest || !e.target.closest('.map-search')) $.mapSearchResults.classList.remove('active'); });

    // Mobile nav toggle
    var sidebarEl = document.querySelector('.sidebar'); var rightEl = document.querySelector('.right');
   var sidebarEl = document.querySelector('.sidebar');
var rightEl   = document.querySelector('.right');
var panelOverlay = document.getElementById('panelOverlay');

document.querySelector('#menuToggle').onclick = function(){
  var anyOpen = sidebarEl.classList.contains('active') || rightEl.classList.contains('active');
  if (anyOpen){
    sidebarEl.classList.remove('active');
    rightEl.classList.remove('active');
    if (panelOverlay) panelOverlay.classList.remove('active');
  } else {
    sidebarEl.classList.add('active');
    if (panelOverlay) panelOverlay.classList.add('active');
  }
};
 $.homeBtn.onclick = async function(){ currentFilterUserId = null; await loadPhotos(null); };
    $.refreshBtn.onclick = async function(){ await refreshUI(); };
    if ($.toggleTimeline) {
    $.toggleTimeline.onclick = async function(){
    const open = $.timelineWrap.classList.contains('hidden');
    $.timelineWrap.classList.toggle('hidden', !open);
    if (open) { await renderTimeline(); }
  };
}

    // Init
    refreshUI();

    // Service Worker sadece http/https
    if ((location.protocol==="http:" || location.protocol==="https:") && "serviceWorker" in navigator){
      navigator.serviceWorker.register("service-worker.js").catch(function(){});
    }

    // PWA Install Prompt (banner)
    (function(){
      var banner = document.createElement('div'); banner.id='installBanner'; banner.className='row'; banner.style.display='none';
      banner.innerHTML = '<button id="btnInstall" class="btn primary">📱 Ana Ekrana Ekle</button>'; document.body.appendChild(banner);
      var deferredPrompt=null;
      window.addEventListener("beforeinstallprompt", function(e){ e.preventDefault(); deferredPrompt=e; banner.style.display="block"; });
      document.addEventListener('click', function(e){ if(e.target && e.target.id==='btnInstall' && deferredPrompt){ banner.style.display='none'; deferredPrompt.prompt(); deferredPrompt.userChoice.then(function(){ deferredPrompt=null; }); } });
      var isIOS=/iphone|ipad|ipod/i.test(navigator.userAgent); var isStandalone=(window.matchMedia&&window.matchMedia('(display-mode: standalone)').matches)||window.navigator.standalone;
      if (isIOS && !isStandalone){ var tip=document.createElement('div'); tip.style.position='fixed'; tip.style.left='50%'; tip.style.transform='translateX(-50%)'; tip.style.bottom='20px'; tip.style.zIndex='3500'; tip.style.background='#111'; tip.style.color='#fff'; tip.style.padding='8px 12px'; tip.style.borderRadius='999px'; tip.textContent='➕ Paylaş › Ana Ekrana Ekle'; document.body.appendChild(tip); setTimeout(function(){ try{ tip.remove(); }catch(e){} }, 8000); }
    })();
    </script> <!-- ilk script burada kapanacak -->

<script>

  // --- Sağ panel hamburger butonu kontrolü ---
  (function(){
    var rightPanel = document.querySelector('.right');
    var rightMenuToggle = document.getElementById('rightMenuToggle');

    if (rightPanel && rightMenuToggle) {


      // iOS tıklama gecikmesi yaşamamak için hem touchstart hem click
      var toggle = function(e){
        e.preventDefault && e.preventDefault();
        rightPanel.classList.toggle('active');
      };
      rightMenuToggle.addEventListener('touchstart', toggle, {passive:false});
      rightMenuToggle.addEventListener('click', toggle);
      if (panelOverlay){
  panelOverlay.addEventListener('click', function(){
    sidebarEl && sidebarEl.classList.remove('active');
    rightEl   && rightEl.classList.remove('active');
    panelOverlay.classList.remove('active');
  });
}


      // Haritaya/arkaya tıklayınca sağ paneli kapatmak istersen (opsiyonel):
      // document.getElementById('map').addEventListener('click', function(){ rightPanel.classList.remove('active'); });
    }
  })();

  </script>
</body>
</html>
